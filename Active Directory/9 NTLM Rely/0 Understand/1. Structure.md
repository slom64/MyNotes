# NTLM Message Structures: Detailed Binary Layouts

Below, I'll detail the exact binary structures for each NTLM message type (NEGOTIATE_MESSAGE/Type 1, CHALLENGE_MESSAGE/Type 2, and AUTHENTICATE_MESSAGE/Type 3) based on the official Microsoft NT LAN Manager (NTLM) Authentication Protocol specification (MS-NLMP). These are the layouts from the start of the signature to the payload, including all fixed fields and variable payload references.

The structures are sequential (fields are laid out in order in the message bytes). All integers are little-endian unless noted. The "message-dependent fields" refer to the fixed-length fields after the common Signature and MessageType that vary by message type:
- **Type 1 (NEGOTIATE_MESSAGE)**: 4 message-dependent fields (NegotiateFlags, DomainNameFields, WorkstationFields, Version).
- **Type 2 (CHALLENGE_MESSAGE)**: 6 message-dependent fields (TargetNameFields, NegotiateFlags, ServerChallenge, Reserved, TargetInfoFields, Version).
- **Type 3 (AUTHENTICATE_MESSAGE)**: 9 message-dependent fields (LmChallengeResponseFields, NtChallengeResponseFields, DomainNameFields, UserNameFields, WorkstationFields, EncryptedRandomSessionKeyFields, NegotiateFlags, Version, MIC).

I've presented each as a table showing the layout (like a "code table" or memory map), with columns for Offset, Field, Size, and Description. The payload is variable and follows the fixed header; it contains data referenced by offsets in the fields (e.g., strings or structures at specific byte positions from the message start). Data in the payload can be in any order, with possible padding.


> [!NOTE]
> You will Notice that each field will contain BufferOffSet. as Examle, if we have field called DomainNameField, this field doesn't have the actual Domain Name. The actual Domain name is in Payload Field. Computer use BufferOffset which calculate the distance from the start of the message to the actual information (Domain name) in Payload field.

## NEGOTIATE_MESSAGE (Type 1)
This is the first message sent by the client to initiate negotiation. Fixed header size: 40 bytes (before payload).

| Offset | Field              | Size (Bytes) | Description                                                                                                                                                                                                                         |
| ------ | ------------------ | ------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0      | Signature          | 8            | Fixed ASCII string: 'N', 'T', 'L', 'M', 'S', 'S', 'P', '\0'. Identifies NTLM message.                                                                                                                                               |
| 8      | MessageType        | 4            | 32-bit unsigned integer: 0x00000001 (indicates NEGOTIATE_MESSAGE).                                                                                                                                                                  |
| 12     | NegotiateFlags     | 4            | 32-bit flags (NEGOTIATE structure) indicating requested/supported options (e.g., Unicode, NTLMv2).                                                                                                                                  |
| 16     | DomainNameFields   | 8            | Metadata for DomainName in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes, offset from message start). Set to 0s if no domain supplied (unless NTLMSSP_NEGOTIATE_OEM_DOMAIN_SUPPLIED flag is set) |
| 24     | WorkstationFields  | 8            | Metadata for WorkstationName in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored),<br>BufferOffset (4 bytes). Set to 0s if no workstation supplied (unless NTLMSSP_NEGOTIATE_OEM_WORKSTATION_SUPPLIED flag is set).             |
| 32     | Version            | 8            | VERSION structure (ProductMajorVersion, ProductMinorVersion, ProductBuild, Reserved, NTLMRevisionCurrent). Set to all 0s if NTLMSSP_NEGOTIATE_VERSION flag not set; used for debugging.                                             |
| 40     | Payload (variable) | Variable     | Contains<br>DomainName (OEM-encoded string, if Len > 0)<br>and/or WorkstationName (OEM-encoded string, if Len > 0). Referenced by offsets; order not fixed; may include padding.                                                    |

## CHALLENGE_MESSAGE (Type 2)
This is the server's response with a challenge. Fixed header size: 48 bytes (before payload).

| Offset | Field              | Size (Bytes) | Description                                                                                                                                                                                                                               |
| ------ | ------------------ | ------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0      | Signature          | 8            | Fixed ASCII string: 'N', 'T', 'L', 'M', 'S', 'S', 'P', '\0'. Identifies NTLM message.                                                                                                                                                     |
| 8      | MessageType        | 4            | 32-bit unsigned integer: 0x00000002 (indicates CHALLENGE_MESSAGE).                                                                                                                                                                        |
| 12     | TargetNameFields   | 8            | Metadata for TargetName in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes). Set to 0s if NTLMSSP_REQUEST_TARGET flag not set; Len/Offset multiples of 2 if Unicode.                                     |
| 20     | NegotiateFlags     | 4            | 32-bit flags (NEGOTIATE structure) indicating selected options based on client's request.                                                                                                                                                 |
| 24     | ServerChallenge    | 8            | 64-bit nonce (random challenge) for client to use in response.                                                                                                                                                                            |
| 32     | Reserved           | 8            | All 0s; ignored on receipt.                                                                                                                                                                                                               |
| 40     | TargetInfoFields   | 8            | Metadata for TargetInfo in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes). Set to 0s if NTLMSSP_NEGOTIATE_TARGET_INFO flag not set.                                                                    |
| 48     | Version            | 8            | VERSION structure. Set to all 0s if NTLMSSP_NEGOTIATE_VERSION flag not set; used for debugging.                                                                                                                                           |
| 56     | Payload (variable) | Variable     | Contains <br>TargetName (negotiated charset string, e.g., domain/server name)<br>and/or TargetInfo (sequence of AV_PAIR structures, terminated by MsvAvEOL; Unicode values). Referenced by offsets; order not fixed; may include padding. |

## AUTHENTICATE_MESSAGE (Type 3)
This is the client's final response proving identity. Fixed header size: 88 bytes (before payload; includes MIC).

| Offset | Field                           | Size (Bytes) | Description                                                                                                                                                                                                                                                                                                                                                                                 |
| ------ | ------------------------------- | ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0      | Signature                       | 8            | Fixed ASCII string: 'N', 'T', 'L', 'M', 'S', 'S', 'P', '\0'. Identifies NTLM message.                                                                                                                                                                                                                                                                                                       |
| 8      | MessageType                     | 4            | 32-bit unsigned integer: 0x00000003 (indicates AUTHENTICATE_MESSAGE).                                                                                                                                                                                                                                                                                                                       |
| 12     | LmChallengeResponseFields       | 8            | Metadata for LmChallengeResponse in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored),<br>BufferOffset (4 bytes). Len=0 if not sent.                                                                                                                                                                                                                                                    |
| 20     | NtChallengeResponseFields       | 8            | Metadata for NtChallengeResponse in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes). Len=0 if not sent.                                                                                                                                                                                                                                                   |
| 28     | DomainNameFields                | 8            | Metadata for DomainName in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes). Len/Offset multiples of 2 if Unicode; Len=0 if not sent.                                                                                                                                                                                                                      |
| 36     | UserNameFields                  | 8            | Metadata for UserName in payload: Len (2 bytes, excluding NULL),<br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes). Len/Offset multiples of 2 if Unicode; Len=0 if not sent.                                                                                                                                                                                                         |
| 44     | WorkstationFields               | 8            | Metadata for Workstation in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes). Len/Offset multiples of 2 if Unicode; Len=0 if not sent.                                                                                                                                                                                                                     |
| 52     | EncryptedRandomSessionKeyFields | 8            | Metadata for EncryptedRandomSessionKey in payload: Len (2 bytes), <br>MaxLen (2 bytes, ignored), <br>BufferOffset (4 bytes). Len=0 if NTLMSSP_NEGOTIATE_KEY_EXCH flag not set.                                                                                                                                                                                                              |
| 60     | NegotiateFlags                  | 4            | 32-bit flags (NEGOTIATE structure) confirming negotiated options.                                                                                                                                                                                                                                                                                                                           |
| 64     | Version                         | 8            | VERSION structure. Set to all 0s if NTLMSSP_NEGOTIATE_VERSION flag not set; used for debugging.                                                                                                                                                                                                                                                                                             |
| 72     | MIC                             | 16           | 16-byte Message Integrity Check (MIC) for the message.                                                                                                                                                                                                                                                                                                                                      |
| 88     | Payload (variable)              | Variable     | Contains all data that have bufferOffset in previous sections<br>Contains <br>LmChallengeResponse (LM_RESPONSE or LMv2_RESPONSE), <br>NtChallengeResponse (NTLM_RESPONSE or NTLMv2_RESPONSE), <br>DomainName, <br>UserName, <br>Workstation (all negotiated charset strings), <br>EncryptedRandomSessionKey (if key exchange). Referenced by offsets; order not fixed; may include padding. |