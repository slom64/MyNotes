### ADCS Certificate Template Attributes

Active Directory Certificate Services (ADCS) certificate templates are objects in Active Directory that define the properties and behaviors of certificates issued by a Certification Authority (CA). These templates are stored under `CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=<domain>`. Each template is an instance of the `pKICertificateTemplate` class, and its attributes control aspects like enrollment rules, key usage, validity periods, and security settings.

Below is a comprehensive list of all key attributes for ADCS certificate templates, compiled from Microsoft's protocol specifications and related documentation. I've included the LDAP display name, data type, whether it's single-valued or multi-valued, a description, and possible values or flags (with explanations where applicable). This covers both general attributes (e.g., `cn`, `displayName`) and ADCS-specific ones (e.g., those prefixed with `msPKI-` or `pKI-`). Note that some attributes are only available in certain template schema versions (e.g., Version 1 in Windows 2000, Version 2+ in Windows Server 2003 and later).

| Attribute Name                           | Data Type       | Single/Multi-Valued | Description                                                                           | Possible Values/Flags                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ---------------------------------------- | --------------- | ------------------- | ------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **cn**                                   | String          | Single              | The common name (internal identifier) of the certificate template.                    | Examples: "Administrator", "User", "CA".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **displayName**                          | String          | Single              | The human-readable display name of the template.                                      | Examples: "Administrator", "User", "Root Certification Authority".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **distinguishedName**                    | String          | Single              | The full LDAP distinguished name (DN) of the template object.                         | Example: "CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=contoso,DC=com".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **flags**                                | DWORD (Integer) | Single              | General configuration flags for the template (bitmask).                               | Examples: 66106, 65745, 65600. Specific meanings vary by context but often include basic enablement flags.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **ntSecurityDescriptor**                 | Binary          | Single              | The security descriptor (ACL) controlling who can enroll, edit, or read the template. | Binary SDDL format; defines permissions like Enroll, Autoenroll, Write. Security implications: Misconfigured ACLs can allow unauthorized enrollment (e.g., ESC4 vulnerabilities).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **revision**                             | DWORD (Integer) | Single              | The major revision number of the template.                                            | Examples: 4, 5, 106. Increments with changes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **pKICriticalExtensions**                | OCTET STRING    | Multi               | OIDs of extensions marked as critical in issued certificates.                         | Examples: "2.5.29.19" (Basic Constraints), "2.5.29.15" (Key Usage), "2.5.29.17" (Subject Alt Name).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **pKIDefaultCSPs**                       | OCTET STRING    | Multi               | Default Cryptographic Service Providers (CSPs) for key generation.                    | Examples: "2,Microsoft Base Cryptographic Provider v1.0", "1,Microsoft Enhanced Cryptographic Provider v1.0". Format: "<priority>,<CSP name>".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **pKIDefaultKeySpec**                    | DWORD (Integer) | Single              | Default key type/specification.                                                       | 1 (AT_KEYEXCHANGE: Key exchange/encryption), 2 (AT_SIGNATURE: Signing).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **pKIExpirationPeriod**                  | OCTET STRING    | Single              | Validity period of issued certificates (in 100-nanosecond intervals, little-endian).  | Examples: 0x00 0x40 0x39 0x87 0x2E 0xE1 0xFE 0xFF (e.g., 2 years). Negative values indicate duration from issuance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **pKIExtendedKeyUsage**                  | OCTET STRING    | Multi               | Extended Key Usage (EKU) OIDs defining certificate purposes.                          | Examples: "1.3.6.1.5.5.7.3.2" (Client Authentication), "1.3.6.1.4.1.311.10.3.4" (Encrypting File System), "1.3.6.1.5.5.7.3.4" (Secure Email). Security: Broad EKUs like "Any Purpose" (2.5.29.37.0) enable misuse (e.g., ESC2).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **pKIKeyUsage**                          | OCTET STRING    | Single              | Key Usage bitmask (X.509 extension).                                                  | Examples: 0xA0 0x00 (Digital Signature + Key Encipherment), 0x86 0x00 (Digital Signature + Non-Repudiation). Bits: 0x80 (Digital Signature), 0x40 (Non-Repudiation), etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **pKIMaxIssuingDepth**                   | Integer         | Single              | Max depth for CA chain (for subordinate CA templates).                                | Examples: 0 (end-entity), -1 (unlimited), positive integers for levels.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **pKIOverlapPeriod**                     | OCTET STRING    | Single              | Renewal overlap period (in 100-nanosecond intervals, little-endian).                  | Examples: 0x00 0x80 0xA6 0x0A 0xFF 0xDE 0xFF 0xFF (e.g., 6 weeks).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **msPKI-Template-Schema-Version**        | DWORD (Integer) | Single              | Schema version of the template (determines available features).                       | 1 (Basic, Windows 2000+; vulnerable to ESC15/CVE-2024-49019 if SAN allowed), 2 (Windows Server 2003+), 3 (2008+), 4 (2012+).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **msPKI-Template-Minor-Revision**        | DWORD (Integer) | Single              | Minor revision number.                                                                | Examples: 0, 1, 4. Tracks small changes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **msPKI-RA-Signature**                   | DWORD (Integer) | Single              | Number of required RA signatures for issuance.                                        | Examples: 0 (none), 1 (one RA). Higher values increase security.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **msPKI-Minimal-Key-Size**               | DWORD (Integer) | Single              | Minimum key length in bits.                                                           | Examples: 512, 1024, 2048. Enforces key strength.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **msPKI-Cert-Template-OID**              | String          | Single              | Unique OID identifying the template.                                                  | Examples: "1.3.6.1.4.1.311.21.8.11034890.834619.12601478.16236816.7255827.176.1.1". Used for referencing in AD.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **msPKI-Supersede-Templates**            | String          | Multi               | Names of templates this one supersedes (for renewal/upgrade).                         | Examples: "DomainController".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **msPKI-RA-Policies**                    | String          | Multi               | Required issuance policy OIDs from RAs.                                               | OIDs like "1.3.6.1.4.1.311.21.5". Must match for enrollment.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **msPKI-RA-Application-Policies**        | String          | Multi               | Application policy OIDs required for RA-signed requests.                              | Examples: "1.3.6.1.4.1.311.20.2.1" (Certificate Request Agent).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **msPKI-Certificate-Policy**             | String          | Multi               | Issuance policy OIDs in the Certificate Policies extension.                           | OIDs from PKI OID container. Security: Links to groups via msDS-OIDToGroupLink can grant privileges (ESC13).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **msPKI-Certificate-Application-Policy** | String          | Multi               | Application policy OIDs (similar to EKUs but in a different extension).               | Examples: "1.3.6.1.5.5.7.3.2" (Client Authentication). Often mirrors pKIExtendedKeyUsage for consistency. In Version 1 templates, can be overridden (ESC15).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **msPKI-Enrollment-Flag**                | DWORD (Integer) | Single              | Enrollment behavior flags (bitmask).                                                  | 0 (default) or bitwise OR:<br>- 0x00000001 (CT_FLAG_INCLUDE_SYMMETRIC_ALGORITHMS: Include S/MIME capabilities).<br>- 0x00000002 (CT_FLAG_PEND_ALL_REQUESTS: Pend requests for approval).<br>- 0x00000004 (CT_FLAG_PUBLISH_TO_KRA: Publish to Key Recovery Agent).<br>- 0x00000008 (CT_FLAG_PUBLISH_TO_DS: Publish to AD userCertificate).<br>- 0x00000010 (CT_FLAG_AUTO_ENROLLMENT_CHECK_USER_DS_CERTIFICATE: Check for existing certs).<br>- 0x00000020 (CT_FLAG_AUTO_ENROLLMENT: Enable autoenrollment).<br>- 0x00000040 (CT_FLAG_PREVIOUS_APPROVAL_VALIDATE_REENROLLMENT: Reuse prior approval).<br>- 0x00000100 (CT_FLAG_USER_INTERACTION_REQUIRED: Require user input).<br>- 0x00000400 (CT_FLAG_REMOVE_INVALID_CERTIFICATE_FROM_PERSONAL_STORE: Remove invalid certs).<br>- 0x00000800 (CT_FLAG_ALLOW_ENROLL_ON_BEHALF_OF: Allow EBO).<br>- 0x00001000 (CT_FLAG_ADD_OCSP_NOCHECK: Add OCSP no-check extension).<br>- 0x00002000 (CT_FLAG_ENABLE_KEY_REUSE_ON_NT_TOKEN_KEYSET_STORAGE_FULL: Reuse keys on full storage).<br>- 0x00004000 (CT_FLAG_NO_SECURITY_EXTENSION: Omit SID extension; enables ESC9 by bypassing strong mapping). Security: Certain flags like 0x00004000 increase risks in authentication.                                                                                                                                                                           |
| **msPKI-Private-Key-Flag**               | DWORD (Integer) | Single              | Private key handling flags (bitmask).                                                 | 0 (default) or bitwise OR:<br>- 0x00000001 (CT_FLAG_REQUIRE_PRIVATE_KEY_ARCHIVAL: Require key archival).<br>- 0x00000010 (CT_FLAG_EXPORTABLE_KEY: Allow export).<br>- 0x00000020 (CT_FLAG_STRONG_KEY_PROTECTION_REQUIRED: Require strong protection).<br>- 0x00000040 (CT_FLAG_REQUIRE_ALTERNATE_SIGNATURE_ALGORITHM: Use alternate sig alg).<br>- 0x00000080 (CT_FLAG_REQUIRE_SAME_KEY_RENEWAL: Require same key for renewal).<br>- 0x00000100 (CT_FLAG_USE_LEGACY_PROVIDER: Use legacy CSP).<br>- 0x00000200 (CT_FLAG_ATTEST_NONE: No attestation).<br>- 0x00000400 (CT_FLAG_ATTEST_REQUIRED: Require attestation).<br>- 0x00000800 (CT_FLAG_ATTEST_PREFERRED: Prefer attestation).<br>- 0x00001000 (CT_FLAG_ATTESTATION_WITHOUT_POLICY: Attest without policy).<br>- 0x00002000 (CT_FLAG_EK_TRUST_ON_USE: EK trust on use).<br>- 0x00004000 (CT_FLAG_EK_VALIDATE_CERT: Validate EK cert).<br>- 0x00008000 (CT_FLAG_EK_VALIDATE_KEY: Validate EK key).<br>- 0x00010000 (CT_FLAG_HELLO_LOGON_KEY: Hello logon key). Security: Exportable keys increase theft risk.                                                                                                                                                                                                                                                                                                                              |
| **msPKI-Certificate-Name-Flag**          | DWORD (Integer) | Single              | Subject name and SAN handling flags (bitmask).                                        | 0 (default) or bitwise OR:<br>- 0x00000001 (CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT: Enrollee supplies subject; risky for impersonation if no approval).<br>- 0x00000008 (CT_FLAG_OLD_CERT_SUPPLIES_SUBJECT_AND_ALT_NAME: Reuse from old cert in renewal).<br>- 0x00010000 (CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT_ALT_NAME: Enrollee supplies SAN; enables ESC1 if low-priv user can specify arbitrary SAN).<br>- 0x00400000 (CT_FLAG_SUBJECT_ALT_REQUIRE_DOMAIN_DNS: Add domain DNS to SAN).<br>- 0x00800000 (CT_FLAG_SUBJECT_ALT_REQUIRE_SPN: Add SPN to SAN).<br>- 0x01000000 (CT_FLAG_SUBJECT_ALT_REQUIRE_DIRECTORY_GUID: Add objectGUID to SAN).<br>- 0x02000000 (CT_FLAG_SUBJECT_ALT_REQUIRE_UPN: Add UPN to SAN; blocks enrollment if no UPN).<br>- 0x04000000 (CT_FLAG_SUBJECT_ALT_REQUIRE_EMAIL: Add email to SAN; blocks if no email).<br>- 0x08000000 (CT_FLAG_SUBJECT_ALT_REQUIRE_DNS: Add DNS host name to SAN; users can't enroll by default).<br>- 0x10000000 (CT_FLAG_SUBJECT_REQUIRE_DNS_AS_CN: Use DNS as CN in subject).<br>- 0x20000000 (CT_FLAG_SUBJECT_REQUIRE_EMAIL: Use email as subject).<br>- 0x40000000 (CT_FLAG_SUBJECT_REQUIRE_COMMON_NAME: Use CN as subject).<br>- 0x80000000 (CT_FLAG_SUBJECT_REQUIRE_DIRECTORY_PATH: Use full DN as subject; blocks some mappings). Security: Flags allowing enrollee-supplied names/SANs are high-risk for spoofing (e.g., ESC1, ESC14). |

### Additional Notes
- **Template Versions and Compatibility**: Attributes like `msPKI-*` are mostly available in Version 2+ templates. Version 1 templates (schema version 1) have fewer attributes but are vulnerable to overrides (e.g., arbitrary policies).
- **Security Considerations**: Many attributes influence vulnerabilities in ADCS, such as ESC1 (enrollee-supplied SAN), ESC9 (no SID extension), or ESC13 (policy-linked groups). Always audit templates for misconfigurations.
- **Not Directly Template Attributes but Related**: `altSecurityIdentities` (on user/computer objects for explicit mappings) and `szOID_NTDS_CA_SECURITY_EXT` (SID extension in certs) interact with these for authentication.

---

> [!Question] Title
> What is the difference between **Certificate Name Flags** and **Enrollment Flags**.

# üî∑ **1. Certificate Name Flags**

These flags control **what the _subject name_ (identity) of the certificate can be**, and who is allowed to define it.
They govern _how the Subject and SAN fields are built_.
Examples of Certificate Name Flags:

|Flag|Meaning|
|---|---|
|**ENROLLEE_SUPPLIES_SUBJECT**|The requester can choose **any Subject / SAN**. This is the root cause of ESC1.|
|SUBJECT_REQUIRE_DIRECTORY_PATH|Requires subject to be pulled from AD|
|SUBJECT_ALT_REQUIRE_UPN|Requires a UPN to be included|
|SUBJECT_ALT_REQUIRE_EMAIL|Requires email SAN|

### üîë Why important for attacks?

If **ENROLLEE_SUPPLIES_SUBJECT** is enabled:
- Any user can request a certificate _claiming to be anyone_, e.g.:
```
CN=Administrator
UPN=administrator@domain.local
```
- This directly enables **ESC1** (full domain compromise if ClientAuth EKU exists).
---
# üî∑ **2. Enrollment Flags**
These control **how enrollment is performed**, not the identity used.
They define behaviors such as:

| Flag                         | Meaning                                         |
| ---------------------------- | ----------------------------------------------- |
| **PUBLISH_TO_DS**            | CA publishes issued certs into Active Directory |
| INCLUDE_SYMMETRIC_ALGORITHMS | Used by smartcard templates                     |
| AUTO_ENROLLMENT              | Allows auto-enrollment by domain GPO            |
| ALLOW_ENROLL_ON_BEHALF_OF    | Template supports ‚Äúenrollment agent‚Äù operations |
| REQUIRE_MANAGER_APPROVAL     | A manager must approve before issuance          |
### üîë Why important for attacks?
- If a template has **ENROLL_ON_BEHALF_OF**, then users holding an **Enrollment Agent** certificate can use that template to perform "enroll on behalf of" (a privilege-escalation path).    
- If **PUBLISH_TO_DS** is enabled, the issued cert becomes visible in AD.
These flags **do NOT affect the subject name** ‚Äî that is controlled only by Certificate Name Flags.
---

# üÜö Summary Table: Certificate Name Flag vs Enrollment Flag

| Category       | Certificate Name Flags                       | Enrollment Flags                                        |
| -------------- | -------------------------------------------- | ------------------------------------------------------- |
| Controls       | How identity (Subject/SAN) is constructed    | How enrollment is performed                             |
| Affects        | Who the certificate claims to be             | Behavior and issuing rules                              |
| Examples       | ENROLLEE_SUPPLIES_SUBJECT                    | PUBLISH_TO_DS, AUTOENROLL, INCLUDE_SYMMETRIC_ALGORITHMS |
| Attack Impact  | Enables ESC1 if combined with ClientAuth EKU | Enables ESC2 / enrollment-agent abuse                   |
| Security Focus | Subject spoofing                             | Enrollment features and approval workflow               |
