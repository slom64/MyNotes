
> [!Question] 
> what is the difference between ESC6 and ESC1 in modern patched systems that have received patch for certifried. In ESC1 we have template that we are able to request a certificate and specify the SAN that we want. In ESC6 we have the CA which enable specifying SAN for all templates....
> why ESC1 can be exploited directly but ESC6 should be combined with ESC9 or ESC16 to be exploited.....

In modern systems fully patched for Certifried (CVE-2022-26923, addressed in May 2022 via KB5014754 with enforcement phases completing by late 2025), both ESC1 and ESC6 involve exploiting the ability to specify arbitrary Subject Alternative Names (SANs) in certificate requests to impersonate privileged accounts (e.g., domain admins) for authentication via Kerberos PKINIT or Schannel. However, they differ in scope, mechanism, and post-patch exploitability due to changes in certificate mapping and the introduction of the szOID_NTDS_CA_SECURITY_EXT extension (OID: 1.3.6.1.4.1.311.25.2), which embeds the requester's SID for "strong" mapping enforcement.

### Key Differences
- **ESC1 (Misconfigured Certificate Template - Template-Level SAN Supply)**:
  - **Mechanism**: Targets a specific certificate template misconfiguration where the `msPKI-Certificate-Name-Flag` includes `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` (0x00000001) or `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT_ALT_NAME` (0x00010000). This allows a low-privileged enrollee (e.g., any domain user with Enroll rights) to supply an arbitrary SAN (e.g., a domain admin's UPN or DNS name) in the Certificate Signing Request (CSR). The template must also have a Client Authentication EKU (or equivalent like Smart Card Logon/Any Purpose), no manager approval required, and be issued by a CA trusted for NT authentication (in NTAuthCertificates).
  - **Scope**: Template-specific; only affects vulnerable templates (e.g., custom or modified "User" templates).
  - **Post-Patch Behavior**: The Certifried patch enforces "strong" certificate mapping via the SID extension and registry keys like `StrongCertificateBindingEnforcement` (defaults to 1/Compatibility mode initially, now 2/Full Enforcement in 2025) and `CertificateMappingMethods`. However, for templates with enrollee-supplied SAN flags, the CA does *not* automatically add the SID extension—attackers can inject a custom `szOID_NTDS_CA_SECURITY_EXT` with the *victim's* SID in the CSR (e.g., using tools like Certify with `/sid:<victim-SID>`). This allows the certificate to pass strong mapping checks and authenticate as the victim.
  - **Why Exploitable Directly**: No need for additional misconfigurations. The attacker controls both the SAN (victim's identity) and SID extension (victim's SID), bypassing strong mapping. In Full Enforcement mode, authentication succeeds without falling back to "weak" SAN/UPN mapping. This remains viable even on fully patched systems, as the patch doesn't prevent enrollee-supplied extensions in these templates.

- **ESC6 (EDITF_ATTRIBUTESUBJECTALTNAME2 Flag - CA-Level SAN Supply)**:
  - **Mechanism**: Targets a CA-wide misconfiguration where the `EDITF_ATTRIBUTESUBJECTALTNAME2` flag (0x00040000) is enabled on the CA (e.g., via `certutil -setreg ca\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2`). This overrides template settings, allowing SAN specification in *any* certificate request, even for templates without enrollee-supplied SAN flags.
  - **Scope**: CA-global; affects all templates issued by that CA, making it broader but less granular than ESC1.
  - **Post-Patch Behavior**: The patch mandates the CA to automatically insert the requester's (attacker's) SID into the szOID_NTDS_CA_SECURITY_EXT for issued certificates. During authentication, strong mapping detects a mismatch (attacker's SID vs. victim's SAN), causing failure (e.g., KDC_ERR_CERTIFICATE_MISMATCH). In Compatibility mode (pre-2025 enforcement), it might fall back to weak mapping if the account predates the cert, but Full Enforcement rejects it outright.
  - **Why Requires ESC9 or ESC16**: Alone, ESC6 allows SAN injection but results in unusable certs due to the enforced SID mismatch. To exploit:
    - **Combine with ESC9 (Template-Level SID Omission)**: The target template must have `msPKI-Enrollment-Flag` set to `CT_FLAG_NO_SECURITY_EXTENSION` (0x00004000), omitting the SID extension. This forces fallback to weak SAN/UPN mapping, allowing impersonation.
    - **Combine with ESC16 (CA-Level SID Omission)**: The CA has a registry key (e.g., `DisableExtensionList` including szOID_NTDS_CA_SECURITY_EXT) or global config disabling the SID extension domain-wide, enabling weak mapping.
    These combos bypass strong enforcement, but ESC6 isn't direct like ESC1 because attackers can't control/inject the SID extension—the CA always adds the attacker's SID unless omitted via ESC9/16.

### Summary of Patch Impact
The Certifried patch shifts from weak (SAN/UPN-based) to strong (SID/extension-based) mapping, phasing out weak fallbacks by 2025. ESC1 survives directly due to enrollee control over extensions in misconfigured templates (often v1 templates lacking modern flags). ESC6 is largely mitigated as the CA enforces the attacker's SID, requiring SID omission chains for viability. Audit with tools like Certipy/Certify to detect these (e.g., `certipy find -vulnerable`).