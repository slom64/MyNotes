### Various Exploitation Scenarios in ESC5

ESC5 revolves around exploiting permissive ACLs on ADCS-related objects in Active Directory's Configuration partition or on the CA itself. These objects include containers like Certificate Templates, Enrollment Services, Certification Authorities, NTAuthCertificates, and even the CA's computer object or its RPC endpoints. The key is identifying which object has weak permissions (e.g., GenericAll, WriteDacl, WriteOwner) and leveraging them to introduce misconfigurations that enable privilege escalation. Below, I'll outline several distinct scenarios you might encounter, focusing on how the specific object and permission type influence the attack path. These vary by environment (e.g., single domain vs. multi-domain forest) and can chain with other techniques like RBCD or template abuses.

#### 1. GenericAll on the CA's Computer Object
This is a common entry point if the CA server is treated like a regular domain computer with lax security. With GenericAll (which includes FullControl), you can manipulate the object's properties directly.
- **Leveraging for RBCD and Private Key Extraction**: Start by setting the msDS-AllowedToActOnBehalfOfOtherIdentity attribute on the CA computer object to point to a controlled account (e.g., your machine account). This enables Resource-Based Constrained Delegation (RBCD), allowing you to impersonate a high-privileged user like a Domain Admin via S4U2Self/S4U2Proxy. Once impersonating the admin, access the CA server (e.g., via WinRM or RDP) to export the CA's certificate private key. With the private key, you could sign arbitrary certificates offline, potentially for persistent access or forging authentication tokens. In a forest, this could escalate from a child domain to the root by targeting cross-domain trusts.
- **Alternative Path with Delegation Abuses**: If the CA object allows unconstrained delegation (via UserAccountControl), request a TGT for the CA machine account and use it for lateral movement, like injecting into lsass for DCSync rights. This is riskier due to logging but effective if constrained delegation isn't viable.
#### 2. GenericAll on the NTAuthCertificates Object
The NTAuthCertificates object (under CN=Public Key Services) lists trusted CAs for domain authentication. Weak ACLs here let you add untrusted certificates, tricking the domain into accepting rogue auth.
- **Injecting a Rogue CA for Authentication Bypass**: With GenericAll, append a self-signed or attacker-generated CA certificate to the cacertificate attribute. This makes the domain trust your rogue CA, allowing you Lto issue certificates for any user (e.g., via a controlled sub-CA) that are valid for PKINIT-based Kerberos authentication. Escalate by requesting a TGT as a Domain Admin, leading to full domain compromise. In multi-domain setups, since this object replicates forest-wide, a compromise in one domain poisons the entire forest, enabling Enterprise Admin access.
- **Chaining with Sub-CA Creation**: If combined with control over the Enrollment Services container, create a subordinate CA under your control, issue it a cert signed by the rogue root, and use it for mass certificate issuance without touching the enterprise CA directly.
#### 3. WriteDacl on the Certificate Templates Container
This container holds all publishable certificate templates. Permissive ACLs (e.g., WriteDacl allowing ACL modifications) let you escalate indirectly by gaining full control first.
- **Creating a Malicious Template for ESC1-Style Abuse**: Use WriteDacl to add an ACE granting yourself GenericAll, then create or modify a template with vulnerable settings (e.g., enrollee-supplied SANs, low EKUs like Client Authentication, no manager approval). Publish it to a CA via the Enrollment Services object, then enroll as a low-priv user to get a cert impersonating an admin. This leads to DCSync or other DA-level actions. In forests, publish the template forest-wide to target root domain admins.
- **Persistence Focus**: Instead of immediate escalation, modify existing templates to include backdoor EKUs (e.g., for code signing), ensuring long-term access even after initial cleanup.
#### 4. WriteOwner on the Enrollment Services Container
This object manages which templates are available for enrollment on specific CAs. WriteOwner lets you change ownership to your account, then edit properties.
- **Publishing Unauthorized Templates**: Take ownership, then add a vulnerable template (e.g., one allowing any user enrollment for smart card logon) to the certificateTemplates attribute of a pKIEnrollmentService object. Enroll for a cert that grants admin-equivalent access, like via Schannel authentication. If the CA is offline or air-gapped, this still works for online subordinates, and in tiered PKI setups, it could compromise the root CA indirectly by chaining cert requests upward.
- **Denial-of-Service Twist**: In defensive testing, you might see this used to remove legitimate templates, but offensively, it's more about adding exploitable ones without alerting on template creation events.
#### 5. FullControl on Certification Authorities Container
This holds details about each CA, including renewal settings and authority info.
- **Altering CA Properties for Key Compromise**: With FullControl, modify attributes like the CA's validity period or renewal key to force a key rollover, potentially exposing private keys during export/import processes. Chain this with access to the CA server (e.g., via stolen creds from another exploit) to dump the key database. In high-security environments with HSMs, this might fail, but in standard setups, it enables offline signing of certs for persistence.
- **Forest-Wide Escalation**: Edit the CA object to make it authoritative for the forest root, allowing cert issuance that crosses domain boundaries, escalating from DA in a child to EA.
#### 6. GenericWrite on RPC/DCOM Interfaces of the CA
If the CA exposes remote management via RPC (e.g., ICertAdminD), weak ACLs on the endpoints allow remote exploitation.
- **Remote Certificate Issuance or Revocation**: Use GenericWrite to alter endpoint permissions, then invoke methods to issue certs without proper enrollment rights or revoke existing ones. This could deny service to legit users or issue a cert for admin impersonation. Combine with ESC3 (vulnerable web enrollment) if web interfaces are exposed.
- **Code Execution Path**: In advanced cases, exploit DCOM for remote code exec on the CA server, leading to private key theft or installing backdoors.
#### Environmental Variations and Considerations
- **Single Domain vs. Forest**: In forests, exploits replicate via the Configuration partition, turning local issues global. For example, WriteDacl on a child domain's PKI object could publish a template usable against the root.
- **Chaining with Other ESCs**: Often, ESC5 sets up ESC1 (template vulns) or ESC2 (enrollment rights). If you have partial perms, chain with RBCD or shadow credentials for initial control.
- **Detection Evasion**: Scenarios with WriteOwner are stealthier than direct writes, as ownership changes might not log as prominently.
- **Mitigation Insights**: Always check inheritanceâ€”disabling it prevents broad group perms like Authenticated Users from cascading.

These scenarios highlight ESC5's adaptability; the exact path depends on enumeration results. If you encounter a specific object or perm in your setup, I can refine the explanation further.