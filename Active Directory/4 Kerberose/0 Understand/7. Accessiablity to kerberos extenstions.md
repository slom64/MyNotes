
> [!question] 
> S4u2Self and S4u2proxy aren't enabled for unconstrained delegation accounts, so in user with unconstrained delegation it doesn't have the right to use s4u2self.
> But in constrained delegation the s4u2proxy is enabled but s4u2self is enabled only if the account has protocol transition is enabled.
> For RBCD accout, the delegator can use s4u2self and s4u2proxy.
> is this is right?

### Unconstrained Delegation
You're correct that S4U2Self and S4U2Proxy are not enabled or used here. Accounts (typically service or computer accounts) configured for unconstrained delegation don't rely on the S4U extensions at all. Instead, the Key Distribution Center (KDC) embeds the user's Ticket-Granting Ticket (TGT) directly into the service ticket (ST) issued to the delegating service. This allows the service to extract the TGT and impersonate the user to any other service without restrictions. No S4U2Self rights are granted because the mechanism bypasses the need for self-impersonation via S4U.

### Constrained Delegation
This is spot on: S4U2Proxy is always enabled for constrained delegation, allowing the front-end service to request an ST to a back-end service (limited to those specified in the `msDS-AllowedToDelegateTo` attribute) on behalf of the user. However, S4U2Self (which obtains an ST to the front-end service itself on behalf of the user) is only fully functional if protocol transition is enabled (i.e., the delegation is set to "Use any authentication protocol"). In this case, S4U2Self issues a forwardable ticket, enabling the full delegation chain even if the initial user authentication wasn't Kerberos (e.g., NTLM).

If protocol transition is disabled (set to "Use Kerberos only"), S4U2Self can still be called but produces a non-forwardable ticket, causing S4U2Proxy to fail for non-Kerberos authentications.

### Resource-Based Constrained Delegation (RBCD)
Correct—the delegating service (front-end) can use both S4U2Self and S4U2Proxy. RBCD shifts control to the resource (back-end) owner, who specifies allowed delegators via the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute. The KDC treats RBCD as always allowing protocol transition (similar to constrained with "Use any authentication protocol" enabled), so S4U2Self generates a forwardable ticket, and S4U2Proxy proceeds to the target service. This works across domains starting from Windows Server 2012 and doesn't require domain admin privileges to configure.

---

## S4U2Self
- It is accessible for any user or machine account that has SPN. If you have the credentials for any user or machine account with SPN you can impersonate the admin to get ST for local services in the machine. This is the case despite of the type of delegation, so this feature is enabled even if we don't have any type of delegation at all.
- **Why?**  Because S4U2Self means: “Give me a service ticket **to me** (my own SPN) on behalf of another user.” so you can access all services in the SPN list of that account impersonating any domain user, but you can't do request impersonate ticket for **any service** in the domain.
### **With S4U2Self + valid credentials + the account has SPNs**

If you compromise an account that has **SPNs**, then:

> You can impersonate **ANY user** (Administrator, krbtgt, Domain Admins, etc.) **to ANY service for which that account has an SPN**.

This is **precisely** how S4U2Self works.

### Example:

If the compromised account has:
```
MSSQLSvc/db1.domain.local
HTTP/webapp.domain.local
WSMAN/server1.domain.local
```
Then you can impersonate any user to:
- MSSQLSvc/db1
- HTTP/webapp
- WSMAN/server1
Using S4U2Self.

This part is 100% correct.
### But the important limitation:

> You can only impersonate users **to the services that belong to that account** — specifically, the SPNs assigned to that service account.

You **cannot** use S4U2Self alone to jump to _other_ services not in its SPN list.
### Why?
Because S4U2Self means:
> “Give me a service ticket **to me** (my own SPN) on behalf of another user.”

| Situation                            | Can you perform S4U2Self? | Why?                                                         |
| ------------------------------------ | ------------------------- | ------------------------------------------------------------ |
| **You have the password**            | ✔ Yes                     | You can ask KDC for a TGT for that service account           |
| **You have the TGT**                 | ✔ Yes                     | You already have a valid session key to request S4U2Self     |
| **You have RCE on the service host** | ✔ Yes                     | You can extract ticket/password/token of the service account |
| **No password, no TGT, no RCE**      | ✖ No                      | You cannot authenticate as the service account               |
