# Active Directory ACL Inheritance - Comprehensive Guide

## 🏗️ **The Inheritance Hierarchy**

Think of AD like a **file system**:
```
Domain (C:\)
├── OU=IT (C:\IT\)
│   ├── User=Alice (C:\IT\Alice.txt)
│   └── Computer=PC01 (C:\IT\PC01.txt)
└── OU=Sales (C:\Sales\)
    └── User=Bob (C:\Sales\Bob.txt)
```

## 🔄 **How Inheritance Works**

### **The Flow of Permissions**
```
Domain (DC=corp,DC=com)
     ↓ inherits TO
Parent OU (OU=Departments)
     ↓ inherits TO  
Child OU (OU=IT)
     ↓ inherits TO
User Object (CN=Alice)
```

## 📊 **Inheritance Types Explained**

### **1. No Inheritance (InheritanceType: None)**
```powershell
# ACE applies ONLY to this specific object
OU=IT (GenericAll - No inheritance)
├── User=Alice ✗ (No effect)
└── Computer=PC01 ✗ (No effect)
```
**Example**: You can modify the OU properties but NOT objects inside it.

### **2. Full Inheritance (InheritanceType: All)**
```powershell
# ACE applies to object + ALL children + grandchildren, etc.
OU=IT (GenericAll - Full inheritance)
├── User=Alice ✓ (Inherits permission)
└── Computer=PC01 ✓ (Inherits permission)
```
**Example**: You can modify OU, users, computers, groups - everything inside.

### **3. Children Only (InheritanceType: Children)**
```powershell
# ACE applies ONLY to direct children (not the container itself)
OU=IT (GenericAll - Children only)
├── User=Alice ✓ (Inherits permission)
└── Computer=PC01 ✓ (Inherits permission)
# But OU=IT itself ✗ (No permission on the container)
```

## 🎯 **Real ACL Examples**

### **Non-Inheritable ACE:**
```
User: naugustine
Object: OU=SERVERS
Rights: GenericAll
Inheritance: None

What you can do:
- Rename OU=SERVERS ✓
- Delete OU=SERVERS ✓  
- Modify User=Admin in OU=SERVERS ✗
- Modify Computer=WEB01 in OU=SERVERS ✗
```

### **Inheritable ACE:**
```
User: naugustine  
Object: OU=SERVERS
Rights: GenericAll
Inheritance: All

What you can do:
- Rename OU=SERVERS ✓
- Delete OU=SERVERS ✓
- Modify User=Admin in OU=SERVERS ✓
- Modify Computer=WEB01 in OU=SERVERS ✓
- Reset passwords, add to groups, etc. ✓
```

## 🔧 **Viewing Inheritance in Tools**

### **PowerView:**
```powershell
Get-ObjectAcl -Identity "OU=SERVERS,DC=corp,DC=com" | 
Select-Object ObjectDN, ActiveDirectoryRights, IdentityReference, InheritanceType
```

**InheritanceType Values:**
- `None` - No inheritance
- `All` - Full inheritance  
- `Children` - Direct children only
- `Descendants` - Grandchildren but not direct children
- `SelfAndChildren` - Object + direct children

### **BloodyAD Output Interpretation:**
When you see `nTSecurityDescriptor`, look for inheritance flags in the ACE strings.

## 🚨 **Blocking Inheritance**

Objects can **BLOCK** inheritance from parents:
```
OU=Departments (GenericAll - Full inheritance)
└── OU=IT (Blocks inheritance) ✗
    └── User=Alice ✗
```

**Blocking inheritance stops the flow of permissions from above.**

## 💡 **Practical Scenarios for HTB**

### **Scenario 1: GenericAll on OU (No Inheritance)**
```bash
# You can:
bloodyAD set object 'OU=SERVERS,DC=hercules,DC=htb' description 'Hacked'
bloodyAD remove object 'OU=SERVERS,DC=hercules,DC=htb'

# You cannot:  
bloodyAD set password 'CN=User,OU=SERVERS,DC=hercules,DC=htb'  # ✗
```

### **Scenario 2: GenericAll on OU (With Inheritance)**
```bash
# You can do everything above PLUS:
bloodyAD set password 'CN=Admin,OU=SERVERS,DC=hercules,DC=htb'
bloodyAD add groupMember 'Domain Admins' 'CN=User,OU=SERVERS,DC=hercules,DC=htb'
bloodyAD set rbcd 'CN=Computer,OU=SERVERS,DC=hercules,DC=htb' 'Attacker$'
```

## 🎪 **The dacledit.py Example Explained**

### **Before:**
```python
# Existing ACE (probably added manually)
User: naugustine
Target: OU=SERVERS  
Rights: GenericAll
Inheritance: None  # Only affects the OU container
```

### **After dacledit.py:**
```python  
# New ACE added by dacledit.py
User: naugustine
Target: OU=SERVERS
Rights: GenericAll  
Inheritance: All  # Affects OU + ALL children
```

**This is why the command "adds" GenericAll to child objects - it's creating a NEW inheritable ACE alongside the existing non-inheritable one.**

## 🔍 **Checking Your Actual Permissions**

```powershell
# See ALL ACEs affecting an object (direct + inherited)
Get-ObjectAcl -Identity "CN=User,OU=SERVERS,DC=hercules,DC=htb" -ResolveGUIDs

# Filter for your user
Get-ObjectAcl -Identity "CN=User,OU=SERVERS,DC=hercules,DC=htb" | 
Where-Object {$_.IdentityReference -like "*naugustine*"}
```

## 🎯 **Key Takeaways:**

1. **Inheritance flows DOWNWARD** from parents to children
2. **Non-inheritable ACEs** only affect the specific object
3. **Inheritable ACEs** affect the object + specified children
4. **Objects can block** inheritance from parents
5. **Multiple ACEs can coexist** - one inheritable, one non-inheritable
6. **This explains why you might have GenericAll on OU but not its contents**

Understanding this distinction is **crucial for AD exploitation** because it determines whether you can just mess with the container or actually compromise all objects inside it!