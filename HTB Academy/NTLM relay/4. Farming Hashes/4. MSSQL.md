## Abusing MSSQL Access

In our first example, we established two sessions from `CMATOS`, one for `SMB` and the other for `MSSQL` on the target `172.16.117.60`. Now that we have gained access to the `MSSQL` service, we can also coerce the account running the MSSQL Service (by default, the computer account, which in this case is `SQL01$`) into authenticating against our attack host and then relay its authentication to any target.

We can use `xp_dirtree`, an undocumented SQL Server system extended procedure that lists every folder, every subfolder, and every file of the path we provide it. In the example below, we capture the hash with an SMB server using `smbserver.py`, however for relaying attacks, we instead use `ntlmrelayx`:

![[Z Assets/Images/9d26aec382c14ab6450d1abdac418663_MD5.gif]]