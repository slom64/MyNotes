# NTLM Cross-protocol Relay Attacks

---

In the previous two sections, we conducted `SMB` post-relay attacks to exploit misconfigurations in Windows. However, it is essential to understand that NTLM authentication relaying is not limited to just the SMB protocol. We can relay NTLM authentication from various protocols, including `SMB` and `HTTP` over `LDAP`, `SMB`, `HTTP`, `MSSQL`, `IMAP`, `RPC`, or any other application protocol capable of transmitting NTLM authentication messages. Each protocol we relay NTLM authentication over allows us to execute distinct attacks. Hence, it is vital to comprehend these protocols and the corresponding attack possibilities.

Because we act as both the client and server when we relay `NTLM` authentication, it is important to know what protocols/services `ntlmrelayx` supports for clients and servers. We can know the available options by inspecting the [source code](https://github.com/fortra/impacket/tree/master/impacket/examples/ntlmrelayx); as a client, we can relay `NTLM` authentication `over` various protocols:

- [HTTP(S)](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/clients/httprelayclient.py)
- [IMAP](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/clients/imaprelayclient.py)
- [LDAP(S)](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/clients/ldaprelayclient.py)
- [MSSQL](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/clients/mssqlrelayclient.py)
- [RPC](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/clients/rpcrelayclient.py)
- [SMBv/1/2/3](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/clients/smbrelayclient.py)
- [SMTP](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/clients/smtprelayclient.py)

However, as a server, we can relay `NTLM` authentication `from` a limited number of protocols:

- [HTTP(S)](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/servers/httprelayserver.py)
- [RAW](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/servers/rawrelayserver.py) (as described in the [Initial support for raw NTLM relay server for lsarelayx](https://github.com/fortra/impacket/pull/1190) PR, this server is protocol agnostic, and it is designed to accept raw `NTLM` messages directly from third-party relay applications, especially [lsarelayx](https://github.com/CCob/lsarelayx).)
- [SMBv/1/2/3](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/servers/smbrelayserver.py)
- [WCF](https://github.com/fortra/impacket/blob/master/impacket/examples/ntlmrelayx/servers/wcfrelayserver.py) ( [Windows Communication Foundation](https://learn.microsoft.com/en-us/dotnet/framework/wcf/whats-wcf))

Suppose that after poisoning the network, we receive `HTTP NTLM` authentication from a client; however, we want to perform post-relay attacks that require `LDAP`, such as dumping the `LDAP` information on the DC. Because the `NTLM` security protocols are all embedded protocols, we can extract the `NTLM` authentication messages from one application protocol and embed them in another, a technique known as `cross-protocol relaying`. The below diagram depicts relaying `HTTP NTLM` authentication over `LDAP`, one type of `cross-protocol relay`:
[[Z Assets/Images/Pasted image 20250915163537.jpeg|Open: Pasted image 20250915163537.png]]
![[Z Assets/Images/Pasted image 20250915163537.jpeg]]
Based on the relay clients and servers of `ntlmrelayx`, we can construct a cross-table that shows what protocols we can relay over other protocols:

  
|**Relay Authentication From**|**Relay Authentication Over**|**Cross-protocol?**|
|---|---|---|
|`HTTP`( `S`)|`HTTP`( `S`)|`No`|
|`HTTP`( `S`)|`IMAP` \| `LDAP`( `S`) \| `MSSQL` \| `RPC` \| `SMBv/1/2/3` \| `SMTP`|`Yes`|
|`SMBv/1/2/3`|`SMBv/1/2/3`|`No`|
|`SMBv/1/2/3`|`HTTP`( `S`) \| `IMAP` \| `LDAP`( `S`) \| `MSSQL` \| `RPC` \| `SMTP`|`Yes`|
|`WCF`|`HTTP`( `S`) \| `IMAP` \| `LDAP`( `S`) \| `MSSQL` \| `RPC` \| `SMBv/1/2/3` \| `SMTP`|`Yes`|

Additionally, [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/ntlm/relay#theory) has a cross-table that shows what connections we can relay with the different session security configurations used by clients and servers:
![[Z Assets/Images/fac13ec4304c15e459eee957c522a2c4_MD5.png]]

In this section, we will learn about `MSSQL`, `LDAP`, `HTTP`, and `RPC` `NTLM cross-protocol relaying`.