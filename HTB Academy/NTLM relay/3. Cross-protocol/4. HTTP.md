## NTLM Relay over HTTP

In the previous post-relay attacks, we relayed `HTTP NTLM` authentication to execute `LDAP` `cross-protocol` post-relay attacks. However, it is also possible to relay `NTLM` authentication from other protocols over `HTTP` to carry out `HTTP` `cross-protocol` post-relay attacks. Notably, these `HTTP` post-relay attacks can grant access to restricted web endpoints, allowing us to perform various actions as authenticated users, such as requesting certificates from `AD CS` web enrollment endpoints and abusing [ADFS](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/ad-fs-overview) login endpoints. We can automate the fuzzing of `NTLM`-enabled webendpoints using [NTLMRecon](https://github.com/praetorian-inc/NTLMRecon).

The [NTLM over HTTP Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ntht/f09cf6e1-529e-403b-a8a5-7368ee096a6a) ( `MS-NTHT`/ `NTHT`) specifies how `NTLM` authentication takes place over `HTTP`. Suppose a web client requests an access-protected endpoint from a web server using a `GET` verb/method request at the (fictional) URL `https://academy.hackthebox.com/protected/unlimitedCubes.php`. The first time the web client tries to access the resource, it will send a `GET` request without the `Authorization` header:
```
GET protected/unlimitedCubes.php
```

The web server responds to the request with the [401](https://www.rfc-editor.org/rfc/rfc9110#section-15.5.2) ( `Unauthorized`) response status and requests the use of `NTLM` challenge/authentication to access this resource by sending the [WWW-Authenticate](https://www.rfc-editor.org/rfc/rfc9110#section-11.6.1) response header with the value `NTLM`:
```
HTTP/1.1 401 Unauthorized
WWW-Authenticate: NTLM
```

Knowing that the web server is requesting `NTLM` authentication, the web client obtains the local user credentials using the [NTLMSSP](https://learn.microsoft.com/en-us/windows-server/security/windows-authentication/security-support-provider-interface-architecture#BKMK_NTLMSSP) security package and then generates a new `GET` request to the web server. The request contains an [Authorization](https://www.rfc-editor.org/rfc/rfc9110#section-11.6.2) header with a base64-encoded `NTLM` `NEGOTIATE_MESSAGE` in `NTLM`-data:
```
GET protected/unlimitedCubes.php
Authorization: NTLM tESsBmE/yNY3lb6a0Ls8Ks19wQX1Lf36vVQEZNqwQn0s8Unew
```

When receiving the response from the web client, the web server decodes the base64-encoded `NTLM`-data contained within the `Authorization` header and passes it to its implementation of `MS-NLMP`. If it accepts this authentication data, the server responds with an HTTP `401` status code and a `WWW-Authenticate` header with an `NTLM` `CHALLENGE_MESSAGE` in `NTLM`-data:
```
HTTP/1.1 401 Unauthorized
WWW-Authenticate: NTLM yNY3lb6a0L6vVxOp3MxIQEZNqwQn0s8UNew33KdZvs1Onv
```

The web client then decodes the base64-encoded `NTLM`-data contained within the `WWW-Authenticate` header and passes it to its implementation of `MS-NLMP`. If this authentication data is valid, the client responds by reissuing the `GET` request with an `Authorization` header that contains an `NTLM` `AUTHENTICATE_MESSAGE` in `NTLM`-data:
```
GET protected/unlimitedCubes.php
Authorization: NTLM kGaXHz6/owHcWRlvGFk8ReUa1O7dNmQL2dZKHo=QEZNqwQn0s8U
```

At last, the web server decodes the base64-encoded `NTLM`-data contained within the `Authorization` header and passes it to its implementation of `MS-NLMP`. If it accepts this authentication data from the web client, the web server responds with an HTTP [Successful 2xx code](https://www.rfc-editor.org/rfc/rfc9110#name-successful-2xx), indicating success, in addition to the requested content. In case the web client we are using (such as browsers) does not support the `NTLM` authentication scheme, we can use the [Proxy-Ez](https://github.com/synacktiv/Prox-Ez) proxy, which can handle all HTTP authentication schemes. Moreover, we can utilize the `NTLMParse` utility within the [ADFSRelay](https://github.com/praetorian-inc/ADFSRelay/) repo to decode base64-encoded `NTLM` messages.

In the `Advanced NTLM Relay Attacks Targeting AD CS` section, we will relay `NTLM` authentication over `HTTP` to carry out `HTTP` `cross-protocol` post-relay attacks, specifically abusing `ESC8`. It is always crucial to remember that relaying `HTTP NTLM` authentication is more powerful compared to `SMB NTLM` authentication, as `HTTP` does not support `session signing` (and therefore relay targets cannot request it), while `SMB` does.