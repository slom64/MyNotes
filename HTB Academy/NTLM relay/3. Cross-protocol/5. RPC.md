## NTLM Relay over RPC

Released by [The Open Group](https://www.opengroup.org/) in 1997, [DCE 1.1: Remote Call Procedure](https://publications.opengroup.org/c706) ( `DCE: RPC`), also referred to as `C706`, serves as the technical specification for the [Distributed Computing Environment](http://www.opengroup.org/dce/info/papers/tog-dce-pd-1296.htm) ( `DCE`) and its [Remote Procedure Call](https://pubs.opengroup.org/onlinepubs/9629399/chap1.htm) ( `RPC`) mechanisms. `C706` comprehensively defines `RPC` services, `interfaces`, `protocols`, `encoding rules`, and the [Interface Definition Language](https://pubs.opengroup.org/onlinepubs/9629399/chap4.htm#tagcjh_08) ( `IDL`).

At the core of `DCE RPC` is the `RPC` (communication) protocol, which enables programs or processes to execute functions on remote servers as if they were local. In `RPC`, a client initiates a procedure call directed to a server on another system via a network. The client transmits a request to the server, specifying the procedure to execute and providing necessary data. Upon receiving the request, the server executes the procedure with the provided data and sends a response containing the results. `IDL` offers a language-independent means to describe interfaces and data structures, facilitating code generation and ensuring effective communication between client and server components in distributed computing environments. Notable `RPC` implementations include `DCE RPC`, [gRPC](https://grpc.io/), [Java RMI](https://www.oracle.com/java/technologies/javase/remote-method-invocation-home.html), [CORBA](https://www.corba.org/), and [DCOM](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0). The `C706` standard is available for reading in [HTML](https://pubs.opengroup.org/onlinepubs/9629399/toc.htm) and [PDF](https://publications.opengroup.org/c706) formats.

Microsoft’s implementation of `DCE RPC` is defined in [Remote Procedure Call Protocol Extensions](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15?source=recommendations) ( `MS-RPCE`/ `RPCE`). `MS-RPCE` is a set of extensions to the `C706` specification; it adds new capabilities, allows for more secure implementations, and sometimes places additional restrictions on `DCE RPC`. `NTLM` authentication is among the various [security providers](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/d4097450-c62f-484b-872f-ddf59a7a0d36) `MS-RPCE` supports:

|**Name**|**Value**|**Security Provider**|
|---|---|---|
|`RPC_C_AUTHN_NONE`|`0x00`|No Authentication|
|`RPC_C_AUTHN_GSS_NEGOTIATE`|`0x09`|`SPNEGO`|
|`RPC_C_AUTHN_WINNT`|`0x0A`|`NTLM`|
|`RPC_C_AUTHN_GSS_SCHANNEL`|`0x0E`|`TLS`|
|`RPC_C_AUTHN_GSS_KERBEROS`|`0x10`|`Kerberos`|
|`RPC_C_AUTHN_NETLOGON`|`0x44`|`Netlogon`|
|`RPC_C_AUTHN_DEFAULT`|`0xFF`|Same as `RPC_C_AUTHN_WINNT`|

Clients and servers can set [authentication levels](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/425a7c53-c33a-4868-8e5b-2a850d40dc73) for `RPC` calls, numeric values indicating the level of authentication or message protection that `RPC` will apply to a specific message exchange; out of the seven authentication levels, if we encounter a relay target with an interface that accepts `RPC_C_AUTHN_LEVEL_CONNECT`, we might be able to relay `NTLM` authentication over it and establish an authenticated session (refer to [Authentication-Level Constants](https://learn.microsoft.com/en-gb/windows/win32/rpc/authentication-level-constants) for more on authentication levels).

The number of `RPC` protocols that we can abuse with `NTLM` relay is minimal, including [Task Scheduler Service Remoting Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-tsch/d1058a28-7e02-4948-8b8d-4a347fa64931) ( `MS-TSCH`) and [ICertPassage Remote Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-icpr/9b8ed605-6b00-41d1-9a2a-9897e40678fc) ( `MS-ICPR`/ `ICPR`); `ntlmrelayx` supports relaying `NTLM` authentication over `TSCH` to achieve remote command execution on Microsoft Exchange Servers.

The tools and techniques we will learn in the `Authentication Coercion` section rely on abusing `RPC` calls. In the `Advanced NTLM Relay Attacks Targeting AD CS`, we will relay `NTLM` authentication over `ICPR` to carry out `RPC cross-protocol` post-relay attacks, specifically abusing `ESC11`.