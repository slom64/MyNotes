
# kerberos phases are named as follows:
1. TGT request: Authentication Service (AS)
2. TGS request: Ticket-Granting Service (TGS)
3. Service request: Application Request (AP)

---
## Authentication Service (AS)
### Request (AS-REQ)
First, the user makes a TGT (or identity card) request. This request is called AS-REQ . But to receive the TGT, they must be able to prove their identity. This request is made to the KDC
(which is the Domain Controller in an Active Directory environment). The KDC holds all user keys.

To prove their identity, the user will send an authenticator . It’s the current timestamp that the user will encrypt with their key. The username is also sent in cleartext so the KDC can
know whom it is dealing with. 


> [!NOTE] Note By Me
> In AS-REQ there is no authenticator message, we encrypt the timestamp as way to prove our identity. So, You may consider this as authenticator.


Upon receiving this request, the KDC will retrieve the username, look for the associated key in its directory, and attempt to decrypt the authenticator. If it succeeds, it means that the user has used the same key as the one registered in its database, so they are authenticated. Otherwise, authentication fails.

This step, called pre-authentication , is not mandatory, but all accounts must do it by default . However, it should be noted that an administrator can disable pre-authentication. In this case, the client no longer needs to send an authenticator. The KDC will send the TGT no matter what happens. We'll talk about this in another section.

### Response (AS-REP)
The KDC, therefore, received the client's request for a TGT. If the KDC successfully decrypts the authenticator (or if `pre-authentication` is disabled for the client), it sends a response
called AS-REP to the user.

To protect the rest of the exchanges, the KDC will generate a temporary session key before replying to the user. The client will use this key for further exchanges. The KDC avoids encrypting all information with the user's key. We stated earlier that Kerberos is a state-less protocol, so the KDC will not store this session key anywhere.

There are two elements that we will find in the AS-REP response:
1. First, we are waiting for the TGT that the user requested. It contains all the user's information and is protected with the KDC's key, so the user can't tamper with it. It also contains a copy of the generated session key .
2. Second is the session key , but this time protected with the user's key .

Therefore, this session key is duplicated in the response—one version is protected with the KDC's key, and another is protected with the user's key.


---

## Ticket-Granting Service (TGS)
The Ticket-Granting Service is a component of the Key Distribution Center (KDC) that is responsible for issuing service tickets.

Typically hosted on a domain controller in the Active Directory domain. When a user or computer requests a service ticket, the request is sent to the TGS component of the KDC,
which verifies the user's or computer's identity and checks their authorization to access the requested resource before issuing a service ticket that can be used to gain access to the
resource.

### Request (TGS-REQ)
The client now has a response from the server to its TGT request. This response contains the TGT, protected by the KDC's key, and a session key, protected by the client's/user's key. It can then decrypt this information to extract this temporary session key.

The next step for the user is to request a Service Ticket ST or TGS ticket with a TGS-REQ message. To do this, they will transmit three things to the KDC:
1. The name of the service they wish to access (SERVICE/HOST, which is the Service Principal Name (SPN) representation)
2. The TGT they previously received, containing their information and a copy of the session key.
3. An authenticator, which will be encrypted using the session key at this time

### Response (TGS-REP)
The KDC receives this TGS request, but Kerberos is a stateless protocol. Thus, the KDC has no idea what information has been exchanged before. It must still verify that the TGS request
is valid. It must verify that the authenticator has been encrypted with the correct session key to do this. And how does the KDC know if the session key used is correct? Remember that there was a copy of the session key in the TGT. The KDC will decrypt the TGT (checking its authenticity along the way) and extract the session key. With this session key, it will be able to verify the authenticator's validity.

If all this is done correctly, the KDC only has to read the requested service and respond to the user with a TGS-REP message. We saw earlier that a session key had been generated for the exchanges between the user and the KDC. Well, it's the same thing here. A new session key is generated for future exchanges between the user and the service. And as before, this session key will be present in two places in the response sent by the KDC to the user. Here are all the elements sent by the KDC:

A `service ticket` or `TGS` ticket containing three elements:
1. The name of the requested service (its SPN)
2. A copy of the user information that was present in the TGT. The service will read this information to determine whether or not the user has the right to use it.
3. A copy of the session key

All this information is encrypted with the user/KDC session key. Within this encrypted response, the user's information and the copy of the user/service session key are also encrypted with the service key.

---
## Application Request (AP)
### Request (AP-REQ)
The user can now decrypt this response to extract the user/service session key and the TGS ticket, but the TGS ticket is protected with the service key. The user can't modify this TGS
ticket, so they can't modify their rights, just like with the TGT.

The user will only transmit this TGS ticket to the service, and just like with the TGS request, <-Corrupted stuff->